*------------------------------------------------------------*
User:                hkatrag1
Date:                December 11, 2017
Time:                23:08:28
Site:                70117250
Platform:            X64_DSRV12
Maintenance Release: 9.04.01M3P062415
EM Version:          14.1
* 
*------------------------------------------------------------*
* Training Log
Date:                December 11, 2017
Time:                23:05:00
*------------------------------------------------------------*
14715  proc freq data=EMWS2.Repl_VariableSet noprint;
14716  table ROLE*LEVEL/out=WORK.ReplMETA;
14717  run;
 
NOTE: There were 26 observations read from the data set EMWS2.REPL_VARIABLESET.
NOTE: The data set WORK.REPLMETA has 4 observations and 4 variables.
NOTE: PROCEDURE FREQ used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
14718  proc print data=WORK.ReplMETA label noobs;
14719  var ROLE LEVEL COUNT;
14720  label ROLE = "%sysfunc(sasmsg(sashelp.dmine, meta_role_vlabel, NOQUOTE))" LEVEL = "%sysfunc(sasmsg(sashelp.dmine, meta_level_vlabel, NOQUOTE))" COUNT = "%sysfunc(sasmsg(sashelp.dmine, rpt_count_vlabel, NOQUOTE))";
14721  title9 ' ';
14722  title10 "%sysfunc(sasmsg(sashelp.dmine, rpt_varSummary_title  , NOQUOTE))";
14723  run;
 
NOTE: There were 4 observations read from the data set WORK.REPLMETA.
NOTE: The PROCEDURE PRINT printed page 1.
NOTE: PROCEDURE PRINT used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
14724  title10;
 
14725  %let EMEXCEPTIONSTRING=;
PERFORMANCE  DETAILS
15067  *------------------------------------------------------------*;
15068  * Repl: Generation of macros and macro variables;
15069  * To see the code generated, set the EM_DEBUG macro variable to SOURCE or _ALL_;
15070  *------------------------------------------------------------*;
 
15071  %let EMEXCEPTIONSTRING=;
15072  *------------------------------------------------------------*;
15073  * TRAIN: Repl;
15074  *------------------------------------------------------------*;
15075  %let EM_ACTION = TRAIN;
15076  %let syscc = 0;
15077  filename x CATALOG 'SASHELP.EMUTIL.EM_VARMACRO.SOURCE';
15078  %inc x;
NOTE: %INCLUDE (level 1) file X is file SASHELP.EMUTIL.EM_VARMACRO.SOURCE.
15080 +%macro em_varMacro(name=emMacro, metadata=, where=, key=NAME, nummacro=, maxvar=-1);
15082 +   filename macFile catalog 'work.emutil.macro.source';
15083 +   %let _METAOBS = 0;
15084 +   %let _maxvar = &maxvar;
15085 +   %if "&_maxvar" eq "" %then %let maxvar = -1;
15087 +   %if (%sysfunc(exist(&metadata))<1 and %sysfunc(exist(&metadata, VIEW))<1)
15088 +                   or (&metadata eq ) %then %do;
15089 +       %put * No metadata data set defined;
15090 +       %goto doend;
15091 +   %end;
15093 +   data _null_;
15094 +      length _STRING_ $80;
15095 +      retain _STRING_ '' maxvar 0;
15096 +      set &metadata end=eof;
15097 +      file macFile;
15098 +      %if %nrbquote(&where) ne %then %do;
15099 +          %let whereClause = where (%nrbquote(&where));
15100 +          %unquote(&whereClause);
15101 +      %end;
15102 +      if _N_=1 then do;
15103 +         string = "%"!!"macro &name;";
15104 +         put string;
15105 +      end;
15106 +      maxvar +1;
15107 +      if (length(_STRING_) + length(trim(&key))+ 4 < 80) then do;
15108 +         _STRING_ = trim(_STRING_)!!' '!!trim(&key);
15109 +         if eof
15110 +            %if  %sysevalf(&_maxvar > 0) %then %do;
15111 +                or maxvar >= &maxvar
15112 +            %end;
15113 +            then do;
15114 +            put _STRING_;
15115 +            string = "%"!!"mend &name;";
15116 +            put string;
15117 +            string = strip(put(_N_, best.));
15118 +            call symput('_METAOBS', string);
15119 +            %if (&nummacro ne ) %then %do;
15120 +                put "%" "global &nummacro;";
15121 +                put "%" "let &nummacro = " string ";";
15122 +            %end;
15123 +            stop;
15124 +         end;
15125 +      end;
15126 +      else do;
15127 +         put _STRING_;
15128 +         _string_ = TRIM(&key);
15129 +         if eof
15130 +            %if  %sysevalf(&_maxvar > 0) %then %do;
15131 +              or maxvar >= &maxvar
15132 +           %end;
15133 +            then do;
15134 +            put _STRING_;
15135 +            string = "%"!!"mend &name;";
15136 +            put string;
15137 +        end;
15138 +      end;
15139 +      if eof
15140 +         %if  %sysevalf(&_maxvar > 0) %then %do;
15141 +             or maxvar >= &maxvar
15142 +         %end;
15143 +         then do;
15144 +         string = strip(put(_N_, best.));
15145 +         call symput('_METAOBS', string);
15146 +         %if (&nummacro ne ) %then %do;
15147 +             put "%" "global &nummacro;";
15148 +             put "%" "let &nummacro = " string ";";
15149 +         %end;
15150 +         stop;
15151 +      end;
15152 +   run;
15154 +   %doend:
15155 +   %if ^&_METAOBS %then %do;
15156 +       data _null_;
15157 +          file macFile;
15158 +          put "%" "macro &name;";
15159 +          put "%" "mend &name;";
15160 +          %if (&nummacro ne ) %then %do;
15161 +              put "%" "global &nummacro;";
15162 +              put "%" "let &nummacro = 0;";
15163 +          %end;
15164 +      run;
15165 +   %end;
15166 +   %inc macFile;
15167 +   filename macFile;
15168 +%mend em_varMacro;
NOTE: %INCLUDE (level 1) ending.
15169  filename X;
NOTE: Fileref X has been deassigned.
15170   %macro main;
15171
15172     filename temp catalog 'sashelp.emmdfy.Replace_macros.source';
15173     %include temp;
15174     filename temp;
15175
15176     %if %upcase(&EM_ACTION) = CREATE %then %do;
15177
15178         filename temp catalog 'sashelp.emmdfy.Replace_create.source';
15179         %include temp;
15180         filename temp;
15181         %create;
15182     %end;
15183     %else
15184     %if %upcase(&EM_ACTION) = TRAIN %then %do;
15185
15186         filename temp catalog 'sashelp.emmdfy.Replace_train.source';
15187         %include temp;
15188         filename temp;
15189         %train;
15190     %end;
15191     %else
15192     %if %upcase(&EM_ACTION) = SCORE %then %do;
15193
15194         filename temp catalog 'sashelp.emmdfy.Replace_score.source';
15195         %include temp;
15196         filename temp;
15197         %score;
15198     %end;
15199     %if %upcase(&EM_ACTION) = REPORT %then %do;
15200
15201         filename temp catalog 'sashelp.emmdfy.Replace_report.source';
15202         %include temp;
15203         filename temp;
15204         %report;
15205     %end;
15206     %if %upcase(&EM_ACTION) = OPENOUTCLASSTABLE %then %do;
15207         filename temp catalog 'sashelp.emmdfy.replace_makeoutclass.source';
15208         %include temp;
15209         filename temp;
15210         %em_replace_openoutclass;
15211     %end;
15212     %if %upcase(&EM_ACTION) = CLOSEOUTCLASSTABLE %then %do;
15213         filename temp catalog 'sashelp.emmdfy.replace_makeoutclass.source';
15214         %include temp;
15215         filename temp;
15216         %em_replace_closeoutclass;
15217     %end;
15218  %mend main;
15219
15220  %main;
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMMDFY.REPLACE_MACROS.SOURCE.
15221 +%macro SetProperties;
15222 +   %em_checkmacro(name=EM_PROPERTY_UNKNOWNLEVEL,    global=Y, value=MODE);
15223 +   %em_checkmacro(name=EM_PROPERTY_CALCMETHOD,      global=Y, value=NONE);
15224 +   %em_checkmacro(name=EM_PROPERTY_PERCENTSCUTOFF,  global=Y, value=0.5);
15225 +   %em_checkmacro(name=EM_PROPERTY_SPACINGSCUTOFF,  global=Y, value=9);
15226 +   %em_checkMacro(name=EM_PROPERTY_MADSCUTOFF,      global=Y, value=9);
15227 +   %em_checkMacro(name=EM_PROPERTY_STDDEVCUTOFF,    global=Y, value=3);
15228 +   %em_checkmacro(name=EM_PROPERTY_REPLACEMETHOD,   global=Y, value=COMPUTED);
15229 +   %em_checkmacro(name=EM_PROPERTY_HIDEVARIABLE,    global=Y, value=N);
15230 +   %em_checkmacro(name=EM_PROPERTY_INTERVALMETHOD,  global=Y, value=NONE);
15231 +   %em_checkmacro(name=EM_PROPERTY_REPORTCOUNT,     global=Y, value=Y);
15232 +
15233 +%mend SetProperties;
15234 +
NOTE: %INCLUDE (level 1) ending.
NOTE: Fileref TEMP has been deassigned.
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMMDFY.REPLACE_TRAIN.SOURCE.
15235 +%macro getLevels(outData=);
15236 +   %if (%EM_BINARY_TARGET %EM_ORDINAL_TARGET %EM_NOMINAL_TARGET
15237 +       %EM_BINARY_INPUT %EM_ORDINAL_INPUT %EM_NOMINAL_INPUT
15238 +       %EM_BINARY_REJECTED %EM_ORDINAL_REJECTED %EM_NOMINAL_REJECTED) eq %then %do;
15239 +       data &outData;
15240 +          length NAME $32 LEVEL $8 FREQUENCY 8 TYPE $1 CRAW $8 NRAW 8 REPLACE_VALUE $200;
15241 +          label NAME =     "%sysfunc(sasmsg(sashelp.dmine, rpt_variable_vlabel, NOQUOTE))"
15242 +                LEVEL=     "%sysfunc(sasmsg(sashelp.dmine, rpt_fmtValue_vlabel, NOQUOTE))"
15243 +                FREQUENCY= "%sysfunc(sasmsg(sashelp.dmine, rpt_count_vlabel, NOQUOTE))"
15244 +                TYPE=      "%sysfunc(sasmsg(sashelp.dmine, meta_type_vlabel, NOQUOTE))"
15245 +                CRAW=      "%sysfunc(sasmsg(sashelp.dmine, rpt_craw_vlabel, NOQUOTE))"
15246 +                NRAW=      "%sysfunc(sasmsg(sashelp.dmine, rpt_nraw_vlabel, NOQUOTE))"
15247 +                REPLACE_VALUE= "%sysfunc(sasmsg(sashelp.dmine, rpt_replace_vlabel, NOQUOTE))";
15248 +          stop;
15249 +       run;
15250 +   %end;
15251 +   %else %do;
15252 +       %em_checkmacro(name=EM_TRAIN_MAXLEVELS, global=Y, value=512);
15253 +        %if "&EM_TRAIN_MAXLEVELS" = "" or "&EM_TRAIN_MAXLEVELS" = "." %then
15254 +            %let EM_TRAIN_MAXLEVELS= 512;
15255 +
15256 +        proc dmdb data=&EM_IMPORT_DATA dmdbcat=emdmdb maxlevel=&EM_TRAIN_MAXLEVELS nonorm CLASSOUT=&outData(drop=CODE FREQPERCENT NMISSPERCENT);
15257 +          class
15258 +            %EM_BINARY_TARGET
15259 +            %EM_ORDINAL_TARGET
15260 +            %EM_NOMINAL_TARGET
15261 +            %EM_BINARY_INPUT
15262 +            %EM_ORDINAL_INPUT
15263 +            %EM_NOMINAL_INPUT
15264 +            %EM_BINARY_REJECTED
15265 +            %EM_ORDINAL_REJECTED
15266 +            %EM_NOMINAL_REJECTED;
15267 +          %if (%EM_FREQ ne ) %then %do;
15268 +             freq %EM_FREQ;
15269 +         %end;
15270 +       run;
15271 +   %end;
15272 +%mend getLevels;
15273 +
15274 +%macro makeOutCLass;
15275 +   %em_getname(key=OUTCLASS,  type=DATA);
15276 +   %em_getname(key=NEWVALUES, type=DATA);
15277 +
15278 +   %let data= REPLACE_DATA;
15279 +   %if %sysfunc(exist(&EM_USER_OUTCLASS)) %then %do;
15280 +       data &data(rename=(REPLACE_VALUE=NEW_REPLACE_VALUE));
15281 +          set &EM_USER_OUTCLASS;
15282 +          keep NAME TYPE LEVEL REPLACE_VALUE;
15283 +          where REPLACE_VALUE ne '';
15284 +       run;
15285 +       proc sort data=&Data;
15286 +          by NAME TYPE LEVEL;
15287 +       run;
15288 +   %end;
15289 +
15290 +   %getLevels(outdata=&EM_USER_OUTCLASS);
15291 +
15292 +   /* Determine Mode */
15293 +   proc sort data=&EM_USER_OUTCLASS;
15294 +      by NAME DESCENDING FREQUENCY;
15295 +   run;
15296 +   data _null_;
15297 +      dsid = open("&EM_USER_OUTCLASS");
15298 +      levelLen = varlen(dsid, varnum(dsid, "LEVEL"));
15299 +      dsid = close(dsid);
15300 +      call symput("levelLen", put(max(levelLen, 9), BEST.));
15301 +   run;
15302 +
15303 +   data &EM_USER_OUTCLASS;
15304 +      length Name $32 LEVEL $&levelLen;
15305 +      set &EM_USER_OUTCLASS;
15306 +      length REPLACE_VALUE $200;
15307 +      label REPLACE_VALUE="%sysfunc(sasmsg(sashelp.dmine, rpt_replace_vlabel, NOQUOTE))";
15308 +      by NAME;
15309 +      output;
15310 +      if last.name then do;
15311 +         LEVEL="_UNKNOWN_";
15312 +         Frequency=.;
15313 +         CRAW='';
15314 +         NRAW=.;
15315 +         REPLACE_VALUE="_DEFAULT_";
15316 +         output;
15317 +      end;
15318 +   run;
15319 +
15320 +   /* If the file is a copy of an existing one.  Merge previously specified values */
15321 +   %if %sysfunc(exist(&EM_USER_NEWVALUES)) and (&EM_USER_NEWVALUES ne ) %then %do;
15322 +       proc sort data=&EM_USER_NEWVALUES(rename=(REPLACE_VALUE=NEW_REPLACE_VALUE));
15323 +          by NAME TYPE LEVEL;
15324 +       run;
15325 +       proc sort data=&EM_USER_OUTCLASS;
15326 +          by NAME TYPE LEVEL;
15327 +       run;
15328 +       data &EM_USER_OUTCLASS(drop=NEW_REPLACE_VALUE);
15329 +          merge &EM_USER_OUTCLASS(in=_a) &EM_USER_NEWVALUES(in=_b);
15330 +          by NAME TYPE LEVEL;
15331 +          if _a then do;
15332 +             if _b then REPLACE_VALUE=NEW_REPLACE_VALUE;
15333 +             output;
15334 +          end;
15335 +       run;
15336 +       %let lib    = %scan(&EM_USER_NEWVALUES, 1, .);
15337 +       %let member = %scan(&EM_USER_NEWVALUES, 2, .);
15338 +       proc datasets lib=&lib nolist;
15339 +          delete &member;
15340 +       run;
15341 +
15342 +   %end;
15343 +
15344 +   /*  Update the OUTCLASS data using REPLACEMENT values previously specified */
15345 +   %if %sysfunc(exist(&Data)) %then %do;
15346 +       proc sort data=&EM_USER_OUTCLASS;
15347 +          by NAME TYPE LEVEL;
15348 +       run;
15349 +       proc sort data=&data;
15350 +          by NAME TYPE LEVEL;
15351 +       run;
15352 +       data &EM_USER_OUTCLASS(drop=NEW_REPLACE_VALUE);
15353 +          merge &EM_USER_OUTCLASS(in=_a) &Data(in=_b);
15354 +          by NAME TYPE LEVEL;
15355 +          if _a then do;
15356 +             if _b then REPLACE_VALUE=NEW_REPLACE_VALUE;
15357 +             output;
15358 +          end;
15359 +       run;
15360 +   %end;
15361 +   proc sort data=&EM_USER_OUTCLASS;
15362 +      by NAME DESCENDING FREQUENCY;
15363 +   run;
15364 +
15365 +   %let lib = WORK;
15366 +   %if %index(&EM_USER_OUTCLASS, .) %then %do;
15367 +       %let lib    = %scan(&EM_USER_OUTCLASS, 1, .);
15368 +       %let member = %scan(&EM_USER_OUTCLASS, 2, .);
15369 +   %end;
15370 +   %else
15371 +       %let member = &EM_USER_OUTCLASS;
15372 +
15373 +   proc datasets lib=&lib nolist;
15374 +      modify &member;
15375 +      label NAME =     "%sysfunc(sasmsg(sashelp.dmine, rpt_variable_vlabel, NOQUOTE))"
15376 +            LEVEL=     "%sysfunc(sasmsg(sashelp.dmine, rpt_fmtValue_vlabel, NOQUOTE))"
15377 +            FREQUENCY= "%sysfunc(sasmsg(sashelp.dmine, rpt_count_vlabel, NOQUOTE))"
15378 +            TYPE=      "%sysfunc(sasmsg(sashelp.dmine, meta_type_vlabel, NOQUOTE))"
15379 +            CRAW=      "%sysfunc(sasmsg(sashelp.dmine, rpt_craw_vlabel, NOQUOTE))"
15380 +            NRAW=      "%sysfunc(sasmsg(sashelp.dmine, rpt_nraw_vlabel, NOQUOTE))"
15381 +            REPLACE_VALUE= "%sysfunc(sasmsg(sashelp.dmine, rpt_replace_vlabel, NOQUOTE))";
15382 +     %if %sysfunc(exist(&data)) %then %do;
15383 +          delete &data;
15384 +     %end;
15385 +   run;
15386 +
15387 +   /* Create property file.  Only the records with non-missing REPLACE_VALUE */
15388 +   data &EM_USER_NEWVALUES / view=&EM_USER_NEWVALUES;
15389 +      set &EM_USER_OUTCLASS(in=_a);
15390 +      where REPLACE_VALUE ne '';
15391 +      keep NAME TYPE LEVEL REPLACE_VALUE;
15392 +   run;
15393 +%mend makeOutClass;
15394 +
15395 +%macro makeVarLimits;
15396 +     %let madsString =;
15397 +     %stdize(data=&em_import_data, metadata=VARIABLESET, method=MADS,     outStat=work.MADS);
15398 +     %if %sysfunc(exist(work.MADS)) %then %do;
15399 +         %makeLimits(StatsDs=work.MADS, cutoff=&EM_PROPERTY_MADSCUTOFF, method=MADS);
15400 +         %let madsString = MADS;
15401 +         proc append base=work.LIMITS data=work.MADS force;
15402 +         run;
15403 +     %end;
15404 +
15405 +     %let spacingString = ;
15406 +     %stdize(data=&em_import_data, metadata=VARIABLESET, method=SPACINGS, outStat=work.SPACINGS);
15407 +     %if %sysfunc(exist(work.SPACINGS)) %then %do;
15408 +         %makeLimits(StatsDs=work.SPACINGS, cutoff=&EM_PROPERTY_SPACINGSCUTOFF, method=SPACINGS);
15409 +         %let spacingString = SPACING;
15410 +         proc append base=work.LIMITS data=work.SPACINGS force;
15411 +         run;
15412 +     %end;
15413 +
15414 +     %let percentString = ;
15415 +     %stdize(data=&em_import_data, metadata=VARIABLESET, method=PERCENTS, outStat=work.PERCENTS);
15416 +     %if %sysfunc(exist(work.PERCENTS)) %then %do;
15417 +         %makePctLimits(StatsDs=work.PERCENTS);
15418 +         %let percentString = PERCENTS;
15419 +         proc append base=work.LIMITS data=work.PERCENTS(keep=NAME CALCMETHOD UPPERLIMIT LOWERLIMIT LABEL) force ;
15420 +         run;
15421 +     %end;
15422 +
15423 +     %makeFixedLimits(StatsDs=work.FIXED);
15424 +     %if %sysfunc(exist(work.FIXED)) %then %do;
15425 +         proc append base=work.LIMITS data=work.FIXED(keep=NAME CALCMETHOD UPPERLIMIT LOWERLIMIT LABEL) force ;
15426 +         run;
15427 +     %end;
15428 +
15429 +     %if %sysfunc(exist(work.LIMITS)) %then %do;
15430 +         proc sort data=work.LIMITS;
15431 +            by NAME;
15432 +         run;
15433 +         %em_getName(key=LIMITS, type=DATA);
15434 +         data &EM_USER_LIMITS;
15435 +              merge work.limits(in=_a) variableSet(keep=NAME ROLE LEVEL LABEL REPLACEMETHOD REPLACEMIN REPLACEMAX LABEL);
15436 +              by NAME;
15437 +              if _a then output;
15438 +         run;
15439 +     %end;
15440 +
15441 +
15442 +
15443 +     %if %upcase(&EM_DEBUG)=_ALL_ %then %do;
15444 +          proc print data=&EM_USER_OUTCLASS;run;
15445 +          proc print data=MADS;run;
15446 +          proc print data=spacings;run;
15447 +          proc print data=percents;run;
15448 +          proc print data=limits;run;
15449 +     %end;
15450 +     proc datasets lib=work nolist;
15451 +        delete &madsString &spacingString &percentString limits;
15452 +     run;
15453 +%mend makeVarLimits;
15454 +
15455 +%macro stdize(data=, metadata=, method=, outStat=work.StdizeStat);
15456 +
15457 +    %if &method ne PERCENTS %then %do;
15458 +        %em_varmacro(Name=&method, metadata=&metadata,
15459 +                  where=%nrbquote(CALCMETHOD="&method"));
15460 +    %end;
15461 +    %else %do;
15462 +        %em_varmacro(Name=&method, metadata=&metadata,
15463 +        where=%nrbquote(CALCMETHOD in("STDDEV", "PERCENTS")));
15464 +    %end;
15465 +    %if %&method eq %then %goto doend;
15466 +
15467 +    %let optionString=&method;
15468 +
15469 +    %if &method=MADS %then %let optionString = %nrbquote(method=MAD NORM);
15470 +    %else
15471 +        %if &method=SPACINGS %then %let optionString = %nrbquote(method=spacing(50) NORM);
15472 +        %else
15473 +           %if &method=PERCENTS %then %do;
15474 +               %let uCutoff = %sysevalf(100-&em_property_percentsCutoff);
15475 +               %let optionString = pctlpts=&em_property_PercentsCutoff &uCutoff;
15476 +           %end;
15477 +
15478 +    &em_codebar;
15479 +    * &EM_NODEID: Method &em_property_method;
15480 +    &EM_codebar;
15481 +    proc stdize data=&data outstat=&outstat out=_null_
15482 +       &optionString
15483 +       ;
15484 +       var  %&method;
15485 +       %if %em_freq ne %then %do;
15486 +           freq %em_freq;
15487 +       %end;
15488 +    run;
15489 +
15490 +    %if &method=MADS or &method=SPACINGS %then %do;
15491 +        proc transpose data=&outStat out=&outStat(drop=_LABEL_ rename=(_NAME_=NAME col1=LOCATION col2=SCALE));
15492 +           where _TYPE_ in('LOCATION', 'SCALE');
15493 +        run;
15494 +    %end;
15495 +    %else
15496 +        %if &method=PERCENTS %then %do;
15497 +            proc transpose data=&outStat out=&outStat(drop=_LABEL_ rename=(_NAME_=NAME col1=LOCATION col2=SCALE col3=PMin col4=PMax));
15498 +               where _TYPE_ ^in ('ADD', 'MULT', 'N', 'SumFreqsRead', 'SumFreqsUsed', 'NObsRead', 'NObsUsed', 'NObsMiss');
15499 +           run;
15500 +       %end;
15501 +   %doend:
15502 +%mend stdize;
15503 +
15504 +%macro makeLimits(StatsDs=, cutoff=, method=);
15505 +    %if ^%sysfunc(exist(&StatSDs)) %then %goto doendm;
15506 +    data &StatsDs;
15507 +       set &StatsDs;
15508 +       length CALCMETHOD $10;
15509 +       retain CALCMETHOD "&METHOD";
15510 +       LowerLimit = location - &cutoff*scale;
15511 +       UpperLimit = location + &cutoff*scale;
15512 +       drop location scale;
15513 +       Label LowerLimit =  "%sysfunc(sasmsg(sashelp.dmine, meta_lowerLimit_vlabel, NOQUOTE))"
15514 +             UpperLimit =  "%sysfunc(sasmsg(sashelp.dmine, meta_upperLimit_vlabel, NOQUOTE))";
15515 +    run;
15516 +
15517 +    %doendm:
15518 +%mend makeLimits;
15519 +
15520 +%macro makeFixedLimits(statsDs=);
15521 +    data &statsDs;
15522 +       set VARIABLESET(where=(CALCMETHOD in('MANUAL', 'METALIMIT')) keep=NAME CALCMETHOD UPPERLIMIT LOWERLIMIT INTERVALMIN INTERVALMAX LABEL);
15523 +       by NAME;
15524 +       select(CALCMETHOD);
15525 +          when('METALIMIT') do;
15526 +             if UPPERLIMIT eq . and LOWERLIMIT eq . then delete;
15527 +          end;
15528 +          when('MANUAL') do;
15529 +             if INTERVALMIN eq . and INTERVALMAX eq . then delete;
15530 +             else do;
15531 +                LOWERLIMIT = INTERVALMIN;
15532 +                UPPERLIMIT = INTERVALMAX;
15533 +             end;
15534 +          end;
15535 +          otherwise;
15536 +       end;
15537 +    run;
15538 +    %let nobs=0;
15539 +    %let dsid = %sysfunc(open(&statsDs));
15540 +    %if &dsid>0 %then %do;
15541 +        %let nobs = %sysfunc(attrn(&dsid, NOBS));
15542 +        %let dsid = %sysfunc(close(&dsid));
15543 +    %end;
15544 +    %if ^&nobs %then %do;
15545 +        %let nameDs = %scan(&statsDs, 2, .);
15546 +        proc datasets lib=WORK nolist;
15547 +           delete &nameDs;
15548 +         run;
15549 +    %end;
15550 +
15551 +%mend makeFixedLimits;
15552 +
15553 +%macro makePctLimits(StatsDs=);
15554 +    %if ^%sysfunc(exist(&StatSDs)) %then %goto doendp;
15555 +    data &statsDs;
15556 +       merge &statsDs VARIABLESET(where=(CALCMETHOD in('PERCENTS', 'STDDEV')) keep=NAME CALCMETHOD UPPERLIMIT LOWERLIMIT INTERVALMIN INTERVALMAX LABEL);
15557 +       by NAME;
15558 +       select(CALCMETHOD);
15559 +          when('PERCENTS') do;
15560 +             if PMIN eq . and PMAX eq . then delete;
15561 +             else do;
15562 +                LOWERLIMIT = PMIN;
15563 +                UPPERLIMIT = PMAX;
15564 +             end;
15565 +          end;
15566 +          when('STDDEV') do;
15567 +              LOWERLIMIT = LOCATION - (&EM_PROPERTY_STDDEVCUTOFF*SCALE);
15568 +              UPPERLIMIT = LOCATION + (&EM_PROPERTY_STDDEVCUTOFF*SCALE);
15569 +          end;
15570 +          otherwise;
15571 +       end;
15572 +    run;
15573 +   %doendp:
15574 +%mend makePctLimits;
15575 +
15576 +%macro train;
15577 +
15578 +   %if "&em_import_data" eq "" %then %do;
15579 +       %let emexceptionString = exception.server.IMPORT.NOTRAIN,1;
15580 +       %goto doendm;
15581 +   %end;
15582 +
15583 +    /* Process Class variables */
15584 +    %makeOutClass;
15585 +
15586 +    /* Interval Variables */
15587 +     data VARIABLESET;
15588 +        set &EM_DATA_VARIABLESET(where=(LEVEL="INTERVAL" and ((ROLE in("REJECTED", "TARGET") and USE="Y")
15589 +             or (ROLE="INPUT" and USE in("Y", "D")) )));
15590 +        if CALCMETHOD eq "DEFAULT" then CALCMETHOD="&EM_PROPERTY_CALCMETHOD";
15591 +        if CALCMETHOD ^in("NONE", "METALIMIT") or (CALCMETHOD eq "METALIMIT" and ^(LOWERLIMIT eq . and UPPERLIMIT eq .)) then output;
15592 +     run;
15593 +     proc sort data=VARIABLESET out=VARIABLESET;
15594 +        by NAME;
15595 +     run;
15596 +
15597 +     %let varnum=0;
15598 +     %let dsid = %sysfunc(open(VARIABLESET));
15599 +     %if &dsid>0 %then %do;
15600 +         %let varnum = %sysfunc(attrn(&dsid, NOBS));
15601 +         %let dsid = %sysfunc(close(&dsid));
15602 +     %end;
15603 +     %if ^&varnum %then %do;
15604 +          %em_getName(key=LIMITS, type=DATA);
15605 +          %let limitDs = %scan(&em_user_limits, 2, .);
15606 +          proc datasets lib=&em_lib nolist;
15607 +             delete &limitDs;
15608 +          run;
15609 +     %end;
15610 +     %else %do;
15611 +         %makeVarLimits;
15612 +     %end;
15613 +
15614 +   %doendm:
15615 +
15616 +%mend train;
NOTE: %INCLUDE (level 1) ending.
NOTE: Fileref TEMP has been deassigned.
 
NOTE: There were 0 observations read from the data set EMWS2.REPL_OUTCLASS.
      WHERE REPLACE_VALUE not = ' ';
NOTE: The data set WORK.REPLACE_DATA has 0 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: Input data set is empty.
NOTE: The data set WORK.REPLACE_DATA has 0 observations and 4 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: Records processed = 9686   Memory used = 511K.
NOTE: There were 9686 observations read from the data set BIA.PVA97NK.
NOTE: View EMWS2.STAT_TRAIN.VIEW used (Total process time):
      real time           0.10 seconds
      cpu time            0.09 seconds
 
NOTE: There were 9686 observations read from the data set EMWS2.IDS2_DATA.
NOTE: There were 9686 observations read from the data set EMWS2.STAT_TRAIN.
NOTE: The data set EMWS2.REPL_OUTCLASS has 69 observations and 6 variables.
NOTE: PROCEDURE DMDB used (Total process time):
      real time           0.15 seconds
      cpu time            0.10 seconds
 
 
 
NOTE: There were 69 observations read from the data set EMWS2.REPL_OUTCLASS.
NOTE: The data set EMWS2.REPL_OUTCLASS has 69 observations and 6 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.03 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 69 observations read from the data set EMWS2.REPL_OUTCLASS.
NOTE: The data set EMWS2.REPL_OUTCLASS has 75 observations and 7 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 75 observations read from the data set EMWS2.REPL_OUTCLASS.
NOTE: The data set EMWS2.REPL_OUTCLASS has 75 observations and 7 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.03 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: Input data set is already sorted, no sorting done.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 75 observations read from the data set EMWS2.REPL_OUTCLASS.
NOTE: There were 0 observations read from the data set WORK.REPLACE_DATA.
NOTE: The data set EMWS2.REPL_OUTCLASS has 75 observations and 7 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.03 seconds
 
 
 
NOTE: There were 75 observations read from the data set EMWS2.REPL_OUTCLASS.
NOTE: The data set EMWS2.REPL_OUTCLASS has 75 observations and 7 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.03 seconds
      cpu time            0.03 seconds
 
 
NOTE: MODIFY was successful for EMWS2.REPL_OUTCLASS.DATA.
 
NOTE: The file EMWS2.REPLACE_DATA (memtype=DATA) was not found, but appears on a DELETE statement.
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.04 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: DATA STEP view saved on file EMWS2.REPL_NEWVALUES.
NOTE: A stored DATA STEP view cannot run under a different operating system.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 20 observations read from the data set EMWS2.REPL_VARIABLESET.
      WHERE (LEVEL='INTERVAL') and ((ROLE in ('REJECTED', 'TARGET') and (USE='Y')) or ((ROLE='INPUT') and USE in ('D', 'Y')));
NOTE: The data set WORK.VARIABLESET has 0 observations and 27 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: Input data set is empty.
NOTE: The data set WORK.VARIABLESET has 0 observations and 27 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: The file EMWS2.REPL_LIMITS (memtype=DATA) was not found, but appears on a DELETE statement.
15617  *------------------------------------------------------------*;
15618  * End TRAIN: Repl;
15619  *------------------------------------------------------------*;
15620
15621  *------------------------------------------------------------*;
15622  * Close any missing semi colons;
15623  *------------------------------------------------------------*;
15624  ;
15625  ;
15626  ;
15627  ;
15628  quit;
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.03 seconds
      cpu time            0.03 seconds
 
 
15629  *------------------------------------------------------------*;
15630  * Close any unbalanced quotes;
15631  *------------------------------------------------------------*;
15632  /*; *"; *'; */
15633  ;
15634  run;
15635  quit;
15636  /* Reset EM Options */
15637  options formchar="|----|+|---+=|-/\<>*";
15638  options nocenter ls=256 ps=10000;
15639  goptions reset=all device=GIF NODISPLAY;
 
*------------------------------------------------------------*
* Score Log
Date:                December 11, 2017
Time:                23:08:26
*------------------------------------------------------------*
PERFORMANCE  DETAILS
14984  %let EMEXCEPTIONSTRING=;
14985  *------------------------------------------------------------*;
14986  * SCORE: Repl;
14987  *------------------------------------------------------------*;
14988  %let EM_ACTION = SCORE;
14989  %let syscc = 0;
14990  filename x CATALOG 'SASHELP.EMUTIL.EM_VARMACRO.SOURCE';
14991  %inc x;
NOTE: %INCLUDE (level 1) file X is file SASHELP.EMUTIL.EM_VARMACRO.SOURCE.
14993 +%macro em_varMacro(name=emMacro, metadata=, where=, key=NAME, nummacro=, maxvar=-1);
14995 +   filename macFile catalog 'work.emutil.macro.source';
14996 +   %let _METAOBS = 0;
14997 +   %let _maxvar = &maxvar;
14998 +   %if "&_maxvar" eq "" %then %let maxvar = -1;
15000 +   %if (%sysfunc(exist(&metadata))<1 and %sysfunc(exist(&metadata, VIEW))<1)
15001 +                   or (&metadata eq ) %then %do;
15002 +       %put * No metadata data set defined;
15003 +       %goto doend;
15004 +   %end;
15006 +   data _null_;
15007 +      length _STRING_ $80;
15008 +      retain _STRING_ '' maxvar 0;
15009 +      set &metadata end=eof;
15010 +      file macFile;
15011 +      %if %nrbquote(&where) ne %then %do;
15012 +          %let whereClause = where (%nrbquote(&where));
15013 +          %unquote(&whereClause);
15014 +      %end;
15015 +      if _N_=1 then do;
15016 +         string = "%"!!"macro &name;";
15017 +         put string;
15018 +      end;
15019 +      maxvar +1;
15020 +      if (length(_STRING_) + length(trim(&key))+ 4 < 80) then do;
15021 +         _STRING_ = trim(_STRING_)!!' '!!trim(&key);
15022 +         if eof
15023 +            %if  %sysevalf(&_maxvar > 0) %then %do;
15024 +                or maxvar >= &maxvar
15025 +            %end;
15026 +            then do;
15027 +            put _STRING_;
15028 +            string = "%"!!"mend &name;";
15029 +            put string;
15030 +            string = strip(put(_N_, best.));
15031 +            call symput('_METAOBS', string);
15032 +            %if (&nummacro ne ) %then %do;
15033 +                put "%" "global &nummacro;";
15034 +                put "%" "let &nummacro = " string ";";
15035 +            %end;
15036 +            stop;
15037 +         end;
15038 +      end;
15039 +      else do;
15040 +         put _STRING_;
15041 +         _string_ = TRIM(&key);
15042 +         if eof
15043 +            %if  %sysevalf(&_maxvar > 0) %then %do;
15044 +              or maxvar >= &maxvar
15045 +           %end;
15046 +            then do;
15047 +            put _STRING_;
15048 +            string = "%"!!"mend &name;";
15049 +            put string;
15050 +        end;
15051 +      end;
15052 +      if eof
15053 +         %if  %sysevalf(&_maxvar > 0) %then %do;
15054 +             or maxvar >= &maxvar
15055 +         %end;
15056 +         then do;
15057 +         string = strip(put(_N_, best.));
15058 +         call symput('_METAOBS', string);
15059 +         %if (&nummacro ne ) %then %do;
15060 +             put "%" "global &nummacro;";
15061 +             put "%" "let &nummacro = " string ";";
15062 +         %end;
15063 +         stop;
15064 +      end;
15065 +   run;
15067 +   %doend:
15068 +   %if ^&_METAOBS %then %do;
15069 +       data _null_;
15070 +          file macFile;
15071 +          put "%" "macro &name;";
15072 +          put "%" "mend &name;";
15073 +          %if (&nummacro ne ) %then %do;
15074 +              put "%" "global &nummacro;";
15075 +              put "%" "let &nummacro = 0;";
15076 +          %end;
15077 +      run;
15078 +   %end;
15079 +   %inc macFile;
15080 +   filename macFile;
15081 +%mend em_varMacro;
NOTE: %INCLUDE (level 1) ending.
15082  filename X;
NOTE: Fileref X has been deassigned.
15083   %macro main;
15084
15085     filename temp catalog 'sashelp.emmdfy.Replace_macros.source';
15086     %include temp;
15087     filename temp;
15088
15089     %if %upcase(&EM_ACTION) = CREATE %then %do;
15090
15091         filename temp catalog 'sashelp.emmdfy.Replace_create.source';
15092         %include temp;
15093         filename temp;
15094         %create;
15095     %end;
15096     %else
15097     %if %upcase(&EM_ACTION) = TRAIN %then %do;
15098
15099         filename temp catalog 'sashelp.emmdfy.Replace_train.source';
15100         %include temp;
15101         filename temp;
15102         %train;
15103     %end;
15104     %else
15105     %if %upcase(&EM_ACTION) = SCORE %then %do;
15106
15107         filename temp catalog 'sashelp.emmdfy.Replace_score.source';
15108         %include temp;
15109         filename temp;
15110         %score;
15111     %end;
15112     %if %upcase(&EM_ACTION) = REPORT %then %do;
15113
15114         filename temp catalog 'sashelp.emmdfy.Replace_report.source';
15115         %include temp;
15116         filename temp;
15117         %report;
15118     %end;
15119     %if %upcase(&EM_ACTION) = OPENOUTCLASSTABLE %then %do;
15120         filename temp catalog 'sashelp.emmdfy.replace_makeoutclass.source';
15121         %include temp;
15122         filename temp;
15123         %em_replace_openoutclass;
15124     %end;
15125     %if %upcase(&EM_ACTION) = CLOSEOUTCLASSTABLE %then %do;
15126         filename temp catalog 'sashelp.emmdfy.replace_makeoutclass.source';
15127         %include temp;
15128         filename temp;
15129         %em_replace_closeoutclass;
15130     %end;
15131  %mend main;
15132
15133  %main;
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMMDFY.REPLACE_MACROS.SOURCE.
15134 +%macro SetProperties;
15135 +   %em_checkmacro(name=EM_PROPERTY_UNKNOWNLEVEL,    global=Y, value=MODE);
15136 +   %em_checkmacro(name=EM_PROPERTY_CALCMETHOD,      global=Y, value=NONE);
15137 +   %em_checkmacro(name=EM_PROPERTY_PERCENTSCUTOFF,  global=Y, value=0.5);
15138 +   %em_checkmacro(name=EM_PROPERTY_SPACINGSCUTOFF,  global=Y, value=9);
15139 +   %em_checkMacro(name=EM_PROPERTY_MADSCUTOFF,      global=Y, value=9);
15140 +   %em_checkMacro(name=EM_PROPERTY_STDDEVCUTOFF,    global=Y, value=3);
15141 +   %em_checkmacro(name=EM_PROPERTY_REPLACEMETHOD,   global=Y, value=COMPUTED);
15142 +   %em_checkmacro(name=EM_PROPERTY_HIDEVARIABLE,    global=Y, value=N);
15143 +   %em_checkmacro(name=EM_PROPERTY_INTERVALMETHOD,  global=Y, value=NONE);
15144 +   %em_checkmacro(name=EM_PROPERTY_REPORTCOUNT,     global=Y, value=Y);
15145 +
15146 +%mend SetProperties;
15147 +
NOTE: %INCLUDE (level 1) ending.
NOTE: Fileref TEMP has been deassigned.
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMMDFY.REPLACE_SCORE.SOURCE.
15148 +%macro makeLevelData(data=, outclass=);
15149 +   data REPLACE_MODE;
15150 +      set &OUTCLASS;
15151 +      by NAME;
15152 +      if first.name then do;
15153 +         MODEC    = CRAW;
15154 +         MODEN    = NRAW;
15155 +         NORMMODE = LEVEL;
15156 +         output;
15157 +      end;
15158 +      keep NAME MODEC MODEN NORMMODE UNKWOWNDEFAULT;
15159 +   run;
15160 +
15161 +   proc sort data=&EM_DATA_VARIABLESET;
15162 +      by NAME;
15163 +   run;
15164 +   data &data;
15165 +      length UNKWOWNDEFAULT $8;
15166 +      merge &OUTCLASS(in=_a) REPLACE_MODE &EM_DATA_VARIABLESET(keep=LABEL LENGTH NAME ROLE LEVEL LABEL FORMAT RENAME=(LEVEL=MLEVEL) where=(MLEVEL ne 'INTERVAL'));
15167 +      by NAME;
15168 +      if LEVEL = '_UNKNOWN_' then UNKWOWNDEFAULT = "&EM_PROPERTY_UNKNOWNLEVEL";
15169 +      if _a then output;
15170 +   run;
15171 +   proc datasets lib=work nolist;
15172 +      delete REPLACE_MODE;
15173 +   run;
15174 +   quit;
15175 +%mend makeLevelData;
15176 +
15177 +%macro makeNewNames(limitDs=, classValue=, className=);
15178 +     %let varname = invarname;
15179 +     %let newname = outname;
15180 +     proc sort data=&classValue out=&varname nodupkey;
15181 +        by NAME;
15182 +        where REPLACE_VALUE ^in('', '_DEFAULT_') or (REPLACE_VALUE eq '_DEFAULT_' and UNKWOWNDEFAULT ne 'NONE');
15183 +     run;
15184 +     %let classnum=0;
15185 +     %let dsid = %sysfunc(open(&varname));
15186 +     %if &dsid>0 %then %do;
15187 +         %let classnum = %sysfunc(attrn(&dsid, NOBS));
15188 +         %let dsid = %sysfunc(close(&dsid));
15189 +     %end;
15190 +
15191 +     %let varnum=0;
15192 +     %let dsid = %sysfunc(open(&LimitDs));
15193 +     %if &dsid>0 %then %do;
15194 +         %let varnum = %sysfunc(attrn(&dsid, NOBS));
15195 +         %let dsid = %sysfunc(close(&dsid));
15196 +     %end;
15197 +
15198 +     %if ^&classnum and ^&varnum and ^%sysfunc(exist(&classname)) %then %do;
15199 +         %let lib    = %scan(&classname, 1, .);
15200 +         %let member = %scan(&classname, 2, .);
15201 +          proc datasets lib=&lib nolist;
15202 +             delete &member;
15203 +          run;
15204 +          quit;
15205 +         %goto doendmn;
15206 +     %end;
15207 +
15208 +     data &varname;
15209 +        set
15210 +        %if &classnum %then %do;
15211 +            &varname(keep=NAME)
15212 +        %end;
15213 +        %if &varnum %then %do;
15214 +            &limitDs(keep=NAME)
15215 +        %end;
15216 +        ;
15217 +     run;
15218 +     proc dmdb data=&varname outtable=&newname(rename=(REP=NEWNAME)) nameserver;
15219 +        names NAME;
15220 +        prefix REP_;
15221 +     run;
15222 +     proc sort data=&newname;
15223 +        by NAME;
15224 +     run;
15225 +
15226 +     /* Merge the new names with the limits data set */
15227 +     %if %sysfunc(exist(&limitDs)) %then %do;
15228 +         data &limitDs;
15229 +            merge &newname &limitDs(in=a);
15230 +            by NAME;
15231 +            if a then output;
15232 +         run;
15233 +
15234 +         %let lib    = %scan(&limitDs, 1, .);
15235 +         %let member = %scan(&limitDs, 2, .);
15236 +          proc datasets lib=&lib nolist;
15237 +             modify &member;
15238 +             label NAME    =     "%sysfunc(sasmsg(sashelp.dmine, rpt_variable_vlabel, NOQUOTE))"
15239 +              NEWNAME =     "%sysfunc(sasmsg(sashelp.dmine, rpt_replacevar_vlabel, NOQUOTE))"
15240 +              CALCMETHOD =  "%sysfunc(sasmsg(sashelp.dmine, rpt_calcmethod_vlabel , NOQUOTE))"
15241 +              REPLACEMETHODUSED =  "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemethodused_vlabel, NOQUOTE))"
15242 +              LOWERLIMIT        =  "%sysfunc(sasmsg(sashelp.dmine, meta_lowerLimit_vlabel, NOQUOTE))"
15243 +              REPLACEMINUSED    =  "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemin_vlabel, NOQUOTE))"
15244 +              UPPERLIMIT        =  "%sysfunc(sasmsg(sashelp.dmine, meta_upperLimit_vlabel, NOQUOTE))"
15245 +              REPLACEDMAXUSED   =  "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemax_vlabel, NOQUOTE))"
15246 +              REPLACEMETHOD     =  "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemethod_vlabel, NOQUOTE))"
15247 +              REPLACEMIN =  "%sysfunc(sasmsg(sashelp.dmine, rpt_userreplacemin_vlabel, NOQUOTE))"
15248 +              REPLACEMAX =  "%sysfunc(sasmsg(sashelp.dmine, rpt_userreplacemax_vlabel, NOQUOTE))"
15249 +              ROLE       =  "%sysfunc(sasmsg(sashelp.dmine, meta_role_vlabel, NOQUOTE))"
15250 +              LEVEL      =  "%sysfunc(sasmsg(sashelp.dmine, meta_level_vlabel, NOQUOTE))"
15251 +              LABEL      =  "%sysfunc(sasmsg(sashelp.dmine, meta_label_vlabel, NOQUOTE))";
15252 +         run;
15253 +         quit;
15254 +     %end;
15255 +
15256 +     /* Merge the new names with the Class Value data set */
15257 +     %if %sysfunc(exist(&classValue)) %then %do;
15258 +         data length;
15259 +            retain newlen 0;
15260 +            set &classValue;
15261 +            by NAME;
15262 +            if type eq 'C' then do;
15263 +               if first.name then do;
15264 +                  if REPLACE_VALUE ^in('_DEFAULT_', '_MODE_', '_MISSING_') then
15265 +                     newlen = max(length, length(strip(replace_value)));
15266 +                  else
15267 +                     newlen = length;
15268 +               end;
15269 +               else do;
15270 +                  if REPLACE_VALUE ^in('_DEFAULT_', '_MODE_', '_MISSING_') then
15271 +                     newlen = max(newlen, length(strip(replace_value)));
15272 +               end;
15273 +            end;
15274 +            else newlen = length;
15275 +            len=length;
15276 +            if last.name then output;
15277 +            keep name len newlen role format type label mlevel;
15278 +         run;
15279 +         data &className;
15280 +            length rformat formatroot $32;
15281 +            merge &newname(in=a) length(in=b);
15282 +            by NAME;
15283 +            length=len;
15284 +            if newlen > len then do;
15285 +               if type eq 'C' and format ne '' then do;
15286 +                  rformat = strip(reverse(format));
15287 +                  do while(indexc(rformat, '.0123456789')=1);
15288 +                     rformat = substr(rformat, 2);
15289 +                  end;
15290 +                  formatroot= upcase(reverse(rformat));
15291 +                  if strip(formatRoot) in('$','$F','$UPCASE','$CHAR') then do;
15292 +                     format = strip(formatroot)!!strip(put(newlen, best.))!!'.';
15293 +                  end;
15294 +               end;
15295 +               length = newlen;
15296 +            end;
15297 +            if a and b then output;
15298 +            KEEP name newname role format mlevel type label length;
15299 +         run;
15300 +     %end;
15301 +
15302 +     proc datasets lib=work nolist;
15303 +        delete length &varname &newname;
15304 +     run;
15305 +     quit;
15306 +
15307 +     %doendmn:
15308 +
15309 +%mend makeNewNames;
15310 +
15311 +%macro makeVarDeltaCode(LimitDs=);
15312 +    %if ^%sysfunc(exist(&LimitDs)) %then %goto doendd;
15313 +
15314 +    filename _F1 "&EM_FILE_CDELTA_TRAIN";
15315 +     data _null_;
15316 +        set &LimitDs end=eof;
15317 +        length string $400;
15318 +        file _F1;
15319 +        %if &EM_PROPERTY_HIDEVARIABLE eq Y %then %do;
15320 +            string = 'if NAME="'!!strip(NAME)!!'" then delete;';  put string;
15321 +        %end;
15322 +        %else %do;
15323 +            string = 'if NAME="'!!strip(NAME)!!'" then do;';        put string;
15324 +            string = '   ROLE="REJECTED";';                         put string;
15325 +            string = '   COMMENT= "Replaced by '!!"&EM_NODEID"!!'";'; put string;
15326 +            string = 'end;';                                        put string;
15327 +        %end;
15328 +        put 'else';
15329 +        string = '   if NAME="'!!strip(NEWNAME)!!'" then do;'; put string;
15330 +        string = '      ROLE="'!!strip(ROLE)!!'";';            put string;
15331 +        string = '      LEVEL="'!!strip(LEVEL)!!'";';          put string;
15332 +        put      'end;';
15333 +        if ^eof then
15334 +           put 'else';
15335 +   run;
15336 +   filename _F1;
15337 +
15338 +    %doendd:
15339 +%mend makeVarDeltaCode;
15340 +
15341 +%macro makeVarScoreCode(LimitDs=, File=);
15342 +    %if ^%sysfunc(exist(&LimitDs)) or "&File" eq "" %then %goto doendm;
15343 +
15344 +     filename sFile "&file";
15345 +     data &LimitDs;
15346 +        set &LimitDs end=eof;
15347 +        length REPLACEMETHODUSED $8 string $400;
15348 +        file sFile;
15349 +        put'* ;';
15350 +        put'* Variable: ' name ';';
15351 +        put '* ;';
15352 +        if strip(label) = '' then label = name;
15353 +        string= 'Label '!!strip(newname)!!"='Replacement: "!!strip(tranwrd(label, "'","''"))!!"';";
15354 +        put string;
15355 +        put newname '=' name ';';
15356 +        REPLACEMETHODUSED = REPLACEMETHOD;
15357 +        if REPLACEMETHOD = 'DEFAULT' then
15358 +            %if "&EM_PROPERTY_REPLACEMETHOD" = "COMPUTED" %then %do;
15359 +                REPLACEMETHODUSED = 'COMPUTED';
15360 +            %end;
15361 +            %else
15362 +            %if "&EM_PROPERTY_REPLACEMETHOD" = "MISSING" %then %do;
15363 +                REPLACEMETHODUSED = 'MISSING';
15364 +            %end;
15365 +            %else %do;
15366 +                REPLACEMETHODUSED = 'MANUAL';
15367 +            %end;
15368 +
15369 +        put 'if ' name ' eq . then ' newname  '= . ;';
15370 +        if LowerLimit ne . then do;
15371 +           select(REPLACEMETHODUSED);
15372 +              when('COMPUTED') REPLACEMINUSED = lowerLimit;
15373 +              when('MISSING')  REPLACEMINUSED = .;
15374 +              when('MANUAL')   REPLACEMINUSED = replaceMin;
15375 +              otherwise;
15376 +           end;
15377 +           put 'else';
15378 +           put 'if ' name '<' lowerLimit ' then ' newname ' = ' REPLACEMINUSED ';';
15379 +        end;
15380 +        if upperLimit ne . then do;
15381 +           select(REPLACEMETHODUSED);
15382 +              when('COMPUTED') REPLACEMAXUSED = upperLimit;
15383 +              when('MISSING')  REPLACEMAXUSED = .;
15384 +              when('MANUAL')   REPLACEMAXUSED = replaceMax;
15385 +              otherwise;
15386 +           end;
15387 +           put 'else';
15388 +           put 'if ' name '>' upperLimit  ' then ' newname ' = ' REPLACEMAXUSED ';';
15389 +        end;
15390 +        drop string;
15391 +    run;
15392 +    filename sfile;
15393 +    %doendm:
15394 +%mend makeVarScoreCode;
15395 +
15396 +
15397 +%macro makeUnknownOptCode(Folder=, Data=);
15398 +    %if ^%sysfunc(exist(&Data)) %then %goto doendu;
15399 +
15400 +    %let dsid = %sysfunc(open(&data));
15401 +    %let nameNum    = %sysfunc(varnum(&dsid, Name));
15402 +    %let newnameNum = %sysfunc(varnum(&dsid, NewName));
15403 +
15404 +    %let oldname=;
15405 +    %do %while(^%sysfunc(fetch(&dsid)));
15406 +        %let name    = %sysfunc(getvarc(&dsid, &nameNum));
15407 +        %let newName = %sysfunc(getvarc(&dsid, &newnameNum));
15408 +
15409 +        %if &name ne &oldname %then %do;
15410 +            filename _F1 "&Folder&em_dsep.&newname..sas" MOD;
15411 +            data _null_;
15412 +               set &Data end=eof;
15413 +               where NAME ="&name";
15414 +               length string $400;
15415 +               length newlevel replaceLevel $400;
15416 +               retain string missingFlag;
15417 +               file _F1;
15418 +               if _N_=1 then do;
15419 +                  put '*;';
15420 +                  if format ne '' then do;
15421 +                     string = '_UFORMAT200 = '!!'strip(put('!!strip(NAME)!!','!!strip(format)!!'));';
15422 +                     put string;
15423 +                     put 'if ^(_UFORMAT200 in(';
15424 +                  end;
15425 +                  else do;
15426 +                     if type eq 'C' then do;
15427 +                        string = '_UFORMAT200 = '!!'strip('!!strip(NAME)!!');';
15428 +                        put string;
15429 +                        put 'if ^(_UFORMAT200 in(';
15430 +                     end;
15431 +                     else
15432 +                        put 'if (';
15433 +                  end;
15434 +                  string='';
15435 +                  missingFlag = 0;
15436 +               end;
15437 +
15438 +               if ^eof and LEVEL ne '_UNKNOWN_' then do;
15439 +                  if format ne '' or type eq 'C' then do;
15440 +                     newlevel = tranwrd(strip(LEVEL),'"','""');
15441 +                     if strip(newLevel) = '' then missingFlag = 1;
15442 +                     if length(strip(newlevel))+length(strip(string))+4<80 then do;
15443 +                        if string='' then
15444 +                           string = strip(string)!!' "'!!strip(newlevel)!!'" ';
15445 +                        else
15446 +                           string = strip(string)!!', "'!!strip(newlevel)!!'" ';
15447 +                     end;
15448 +                     else do;
15449 +                        put string;
15450 +                        string =', "'!!tranwrd(strip(LEVEL),'"','""')!!'"';
15451 +                     end;
15452 +                  end;
15453 +                  else do;
15454 +                     string = strip(name)!!' ne '!!strip(level)!!' and ';
15455 +                     put string;
15456 +                  end;
15457 +                  newlevel = ' ';
15458 +               end;
15459 +               else do;
15460 +                  if format ne '' or type eq 'C' then do;
15461 +                     put string;
15462 +                     if ^missingFlag then
15463 +                        string = ', "" )) then ';
15464 +                     else
15465 +                        string = ')) then ';
15466 +                  end;
15467 +                  else
15468 +                     string = strip(name)!!' ne . ) then ';
15469 +                  put string;
15470 +
15471 +                 select(REPLACE_VALUE);
15472 +                 when('_MODE_') do;
15473 +                    if type eq 'C' then
15474 +                       replaceLevel = NORMMODE;
15475 +                    else
15476 +                       replaceLevel =strip(put(MODEN,BEST.));
15477 +                 end;
15478 +                 when('_MISSING_') do;
15479 +                    if type eq 'C' then replaceLevel = '';
15480 +                    else replaceLevel = '.';
15481 +                 end;
15482 +                 when('_DEFAULT_') do;
15483 +                    %if &EM_PROPERTY_UNKNOWNLEVEL = MODE %then %do;
15484 +                        if type eq 'C' then
15485 +                           replaceLevel = NORMMODE;
15486 +                        else
15487 +                           replaceLevel = strip(put(MODEN,BEST.));
15488 +                    %end;
15489 +                    %else %do;
15490 +                        if type eq 'C' then replaceLevel = '';
15491 +                         else replaceLevel = '.';
15492 +                    %end;
15493 +                  end;
15494 +                  when('') do;
15495 +                  end;
15496 +                  otherwise do;
15497 +                     if type eq 'C' then replaceLevel= replace_Value;
15498 +                     else replaceLevel = replace_Value;
15499 +                  end;
15500 +               end;
15501 +               if type eq 'C' then do;
15502 +                  string = strip(newname)!!'= "'!!tranwrd(strip(replaceLevel),'"','""')!!'";';
15503 +               end;
15504 +               else do;
15505 +                  string = strip(newname)!!'= '!!strip(replaceLevel)!!';';
15506 +               end;
15507 +               put string;
15508 +            end;
15509 +
15510 +           run;
15511 +           filename _F1;
15512 +           proc datasets lib=work nolist;
15513 +              delete _temp;
15514 +           run;
15515 +           quit;
15516 +
15517 +           %let oldname = &name;
15518 +        %end;
15519 +    %end;
15520 +    %let dsid = %sysfunc(close(&dsid));
15521 +
15522 +    %doendu:
15523 +%mend makeUnknownOptCode;
15524 +
15525 +%macro makeUnknownCode(ScoreFile=, Data=);
15526 +   %if ^%sysfunc(exist(&Data)) %then %goto doendm;
15527 +
15528 +   filename _F1 "&ScoreFile" MOD;
15529 +   data _null_;
15530 +      set &Data;
15531 +      length string $400;
15532 +      length newlevel replaceLevel $200;
15533 +      retain string missingFlag;
15534 +      file _F1;
15535 +      by NAME;
15536 +
15537 +      if _N_=1 then do;
15538 +         put '* ;';
15539 +         put '* Replace Unknown Class Levels ;';
15540 +         put '* ;';
15541 +         put 'length _UFORMAT200 $200;';
15542 +         put 'drop   _UFORMAT200;';
15543 +         put '_UFORMAT200 = " ";';
15544 +      end;
15545 +
15546 +      if first.name then do;
15547 +         missingFlag = 0;
15548 +         put '*;';
15549 +
15550 +         if format ne '' then do;
15551 +            call symput('UFormatFlag', '1');
15552 +            string = '_UFORMAT200 = '!!'strip(put('!!strip(NAME)!!','!!strip(format)!!'));';
15553 +            put string;
15554 +            put 'if ^(_UFORMAT200 in(';
15555 +         end;
15556 +         else do;
15557 +            if type eq 'C' then do;
15558 +               call symput('UFormatFlag', '1');
15559 +               string = '_UFORMAT200 = '!!'strip('!!strip(NAME)!!');';
15560 +               put string;
15561 +               put 'if ^(_UFORMAT200 in(';
15562 +            end;
15563 +            else
15564 +               put 'if (';
15565 +         end;
15566 +         string='';
15567 +      end;
15568 +
15569 +      if ^last.name and LEVEL ne '_UNKNOWN_' then do;
15570 +        if format ne '' or type eq 'C' then do;
15571 +           newlevel = tranwrd(strip(LEVEL),'"','""');
15572 +           if strip(newLevel) = '' then missingFlag = 1;
15573 +           if length(strip(newlevel))+length(strip(string))+4<80 then do;
15574 +              if string='' then
15575 +                 string = strip(string)!!' "'!!strip(newlevel)!!'" ';
15576 +              else
15577 +                 string = strip(string)!!', "'!!strip(newlevel)!!'" ';
15578 +           end;
15579 +           else do;
15580 +              put string;
15581 +              string =', "'!!tranwrd(strip(LEVEL),'"','""')!!'"';
15582 +           end;
15583 +        end;
15584 +        else do;
15585 +           string = strip(name)!!' ne '!!strip(level)!!' and ';
15586 +           put string;
15587 +        end;
15588 +        newlevel = ' ';
15589 +     end;
15590 +     else do;
15591 +        if format ne '' or type eq 'C' then do;
15592 +           put string;
15593 +           if ^missingFlag then
15594 +              string = ', "" )) then ';
15595 +           else
15596 +              string = ')) then ';
15597 +        end;
15598 +        else
15599 +           string = strip(name)!!' ne . ) then ';
15600 +        put string;
15601 +
15602 +        select(REPLACE_VALUE);
15603 +           when('_MODE_') do;
15604 +              if type eq 'C' then
15605 +                 replaceLevel = NORMMODE;
15606 +              else
15607 +                 replaceLevel =strip(put(MODEN,BEST.));
15608 +           end;
15609 +           when('_MISSING_') do;
15610 +              if type eq 'C' then replaceLevel = '';
15611 +              else replaceLevel = '.';
15612 +           end;
15613 +           when('_DEFAULT_') do;
15614 +              %if &EM_PROPERTY_UNKNOWNLEVEL = MODE %then %do;
15615 +                  if type eq 'C' then
15616 +                     replaceLevel = NORMMODE;
15617 +                  else
15618 +                     replaceLevel = strip(put(MODEN,BEST.));
15619 +              %end;
15620 +              %else %do;
15621 +                  if type eq 'C' then replaceLevel = '';
15622 +                  else replaceLevel = '.';
15623 +              %end;
15624 +           end;
15625 +           when('') do;
15626 +           end;
15627 +           otherwise do;
15628 +               if type eq 'C' then replaceLevel= replace_Value;
15629 +               else replaceLevel = replace_Value;
15630 +           end;
15631 +        end;
15632 +        if type eq 'C' then do;
15633 +           string = strip(newname)!!'= "'!!tranwrd(strip(replaceLevel),'"','""')!!'";';
15634 +        end;
15635 +        else do;
15636 +           string = strip(newname)!!'= '!!strip(replaceLevel)!!';';
15637 +        end;
15638 +        put string;
15639 +     end;
15640 +
15641 +     run;
15642 +     filename _F1;
15643 +    %doendm:
15644 +%mend makeUnknownCode;
15645 +
15646 +%macro makeReplaceCode(ScoreFile=, Data=);
15647 +   filename _F1 "&ScoreFile"  MOD;
15648 +   data _null_;
15649 +      length string $400;
15650 +      set &data end=eof;
15651 +      file _F1;
15652 +      by NAME;
15653 +      if _N_=1 then do;
15654 +         put '   ';
15655 +         put '* ;';
15656 +         put '* Replace Specific Class Levels ;';
15657 +         put '* ;';
15658 +         put 'length _UFormat200 $200;';
15659 +         put 'drop   _UFORMAT200;';
15660 +         put '_UFORMAT200 = " ";';
15661 +      end;
15662 +      if first.name then do;
15663 +         put '* ;';
15664 +         string = '* Variable: '!!strip(NAME)!!';';
15665 +         put string;
15666 +         put '* ;';
15667 +         if format ne '' then do;
15668 +            call symput('UFormatFlag', '1');
15669 +            string = "_UFORMAT200 = strip("; put string;
15670 +            string ='put('!!strip(NAME)!!','!!strip(format)!!'));';
15671 +            put string;
15672 +         end;
15673 +         else
15674 +           if type eq 'C' then do;
15675 +              call symput('UFormatFlag', '1');
15676 +              string = "_UFORMAT200 = strip("!!strip(NAME)!!');';
15677 +              put string;
15678 +           end;
15679 +      end;
15680 +      if ^first.name then
15681 +         put 'else';
15682 +      if format ne '' then do;
15683 +         string = tranwrd(strip(LEVEL),'"','""');
15684 +         string =' if _UFORMAT200 =  "'!!strip(string)!!'" then ';
15685 +         put string;
15686 +      end;
15687 +      else do;
15688 +         if type eq 'N' then do;
15689 +            string = 'if '!!strip(name)!!' = '!!strip(put(nraw, BEST.))!!' then ';
15690 +            put string;
15691 +         end;
15692 +         else do;
15693 +            string = tranwrd(strip(craw),'"','""');
15694 +            string = ' if _UFORMAT200 =  "'!!strip(string)!!'" then ';
15695 +            put string;
15696 +         end;
15697 +      end;
15698 +      string = strip(newname)!!'=';
15699 +      if type eq 'C' then do;
15700 +         if upcase(replace_value) eq '_MISSING_' or
15701 +            (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT)= 'MISSING')) then replace_Value ='';
15702 +         else
15703 +           if upcase(replace_value) eq '_MODE_' or
15704 +            (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT)= 'MODE'))
15705 +            then replace_Value =modec;
15706 +           string = strip(string)!!'"'!!tranwrd(strip(replace_Value),'"','""')!!'";';
15707 +      end;
15708 +      else do;
15709 +         if upcase(replace_value) eq '_MISSING_' or
15710 +            (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT) = 'MISSING')) then replace_Value ='.';
15711 +         else
15712 +           if upcase(replace_value) eq '_MODE_' or
15713 +            (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT) = 'MODE')) then
15714 +                  replace_Value =strip(put(moden, BEST.));
15715 +
15716 +         string = strip(string)!!''!!strip(replace_value)!!';';
15717 +      end;
15718 +      put string;
15719 +    run;
15720 +    filename _F1;
15721 +
15722 +%mend makeReplaceCode;
15723 +
15724 +%macro makeReplaceOptCode(Folder=, Data=);
15725 +    %if ^%sysfunc(exist(&Data)) %then %goto doendr;
15726 +
15727 +    %let dsid = %sysfunc(open(&data));
15728 +    %let nameNum    = %sysfunc(varnum(&dsid, Name));
15729 +    %let newnameNum = %sysfunc(varnum(&dsid, NewName));
15730 +
15731 +    %let oldname=;
15732 +    %do %while(^%sysfunc(fetch(&dsid)));
15733 +        %let name    = %sysfunc(getvarc(&dsid, &nameNum));
15734 +        %let newName = %sysfunc(getvarc(&dsid, &newnameNum));
15735 +
15736 +        %if &name ne &oldname %then %do;
15737 +            filename _F1 "&Folder&em_dsep.&newname..sas" MOD;
15738 +            data _null_;
15739 +               length string $400;
15740 +               set &Data end=eof;
15741 +               by NAME;
15742 +               where NAME ="&name";
15743 +               file _F1;
15744 +               if _N_=1 then do;
15745 +                  put '* ;';
15746 +                  string = '* Variable: '!!strip(NAME)!!';';
15747 +                  put string;
15748 +                  put '* ;';
15749 +                  if format ne '' then do;
15750 +                     string = "_UFORMAT200 = strip("; put string;
15751 +                     string ='put('!!strip(NAME)!!','!!strip(format)!!'));';
15752 +                     put string;
15753 +                  end;
15754 +                  else
15755 +                     if type eq 'C' then do;
15756 +                        call symput('UFormatFlag', '1');
15757 +                        string = "_UFORMAT200 = strip("!!strip(NAME)!!');';
15758 +                        put string;
15759 +                    end;
15760 +               end;
15761 +               if ^first.name then
15762 +                  put 'else';
15763 +               if format ne '' then do;
15764 +                  string = tranwrd(strip(LEVEL),'"','""');
15765 +                  string =' if _UFORMAT200 =  "'!!strip(string)!!'" then ';
15766 +                  put string;
15767 +               end;
15768 +               else do;
15769 +                  if type eq 'N' then do;
15770 +                     string = 'if '!!strip(name)!!' = '!!strip(put(nraw, BEST.))!!' then ';
15771 +                     put string;
15772 +                  end;
15773 +                  else do;
15774 +                     string = tranwrd(strip(craw),'"','""');
15775 +                     string = ' if _UFORMAT200 =  "'!!strip(string)!!'" then ';
15776 +                     put string;
15777 +                  end;
15778 +               end;
15779 +               string = strip(newname)!!'=';
15780 +               if type eq 'C' then do;
15781 +                  if upcase(replace_value) eq '_MISSING_' or
15782 +                     (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT)= 'MISSING')) then replace_Value ='';
15783 +                  else
15784 +                     if upcase(replace_value) eq '_MODE_' or
15785 +                       (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT)= 'MODE'))
15786 +                       then replace_Value =modec;
15787 +                          string = strip(string)!!'"'!!tranwrd(strip(replace_Value),'"','""')!!'";';
15788 +               end;
15789 +              else do;
15790 +                 if upcase(replace_value) eq '_MISSING_' or
15791 +                    (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT) = 'MISSING')) then replace_Value ='.';
15792 +                 else
15793 +                    if upcase(replace_value) eq '_MODE_' or
15794 +                       (upcase(replace_value) eq '_DEFAULT_' and (upcase(UNKWOWNDEFAULT) = 'MODE')) then
15795 +                        replace_Value =strip(put(moden, BEST.));
15796 +
15797 +                 string = strip(string)!!''!!strip(replace_value)!!';';
15798 +              end;
15799 +             put string;
15800 +          run;
15801 +          filename _F1;
15802 +
15803 +           %let oldname = &name;
15804 +        %end;
15805 +    %end;
15806 +    %let dsid = %sysfunc(close(&dsid));
15807 +
15808 +    %doendr:
15809 +
15810 +%mend makeReplaceOptCode;
15811 +
15812 +
15813 +%macro makeNewVarCode(ScoreFile=, Data=);
15814 +   filename _F1 "&ScoreFile"  MOD;
15815 +   data _null_;
15816 +     length string $400;
15817 +      set &data end=eof;
15818 +      file _F1;
15819 +      if _N_=1 then do;
15820 +         put '   ';
15821 +         put '* ;';
15822 +         put '* Defining New Variables;';
15823 +         put '* ;';
15824 +      end;
15825 +      if type eq 'C' then do;
15826 +         string = 'Length '!!strip(newname)!!' $'!!strip(put(length,BEST12.))!!';';
15827 +         put string;
15828 +      end;
15829 +      if strip(label) = '' then label = name;
15830 +      string= 'Label '!!strip(newname)!!"='Replacement: "!!strip(tranwrd(label, "'","''"))!!"';";
15831 +      put string;
15832 +
15833 +      if format ne '' then do;
15834 +         string ='format '!!strip(newname)!!' '!!strip(format)!!';';
15835 +         put string;
15836 +      end;
15837 +      string = strip(newname)!!'= '!!strip(NAME)!!';';
15838 +      put string;
15839 +   run;
15840 +%mend makeNewVarCode;
15841 +
15842 +%macro makeNewVarOptCode(Folder=, Data=);
15843 +    %if ^%sysfunc(exist(&data)) or "&Folder" eq "" %then %goto doendo;
15844 +    data _temp_;set &data;run;
15845 +    %let dsid = %sysfunc(open(_temp_));
15846 +    %let nobs  = %sysfunc(attrn(&dsid, NLOBS));
15847 +    %do %while(^%sysfunc(fetch(&dsid)));
15848 +        %let newNum     = %sysfunc(varnum(&dsid, NewName));
15849 +        %let newname = %sysfunc(getvarc(&dsid, &newNum));
15850 +
15851 +        filename _F1 "&Folder.&em_dsep.&newname..sas";
15852 +        data _null_;
15853 +           length string $400;
15854 +           set &data;
15855 +           where NEWNAME="&newname";
15856 +           file _F1;
15857 +           put '   ';
15858 +           put '* ;';
15859 +           put "* Defining: &newname;";
15860 +           put '* ;';
15861 +           if type eq 'C' then  do;
15862 +              string = 'Length '!!strip(newname)!!'$'!!strip(put(length, best.))!!';';
15863 +              put string;
15864 +           end;
15865 +           if strip(label) = '' then label = name;
15866 +           string= 'Label '!!strip(newname)!!"='Replacement: "!!strip(tranwrd(label, "'","''"))!!"';";
15867 +           put string;
15868 +           if format ne '' then do;
15869 +              string= 'format '!!strip(newname)!!' '!!strip(format)!!';';
15870 +              put string;
15871 +           end;
15872 +           string = strip(newname)!!'='!!strip(name)!!';';
15873 +           put string;
15874 +        run;
15875 +    %end;
15876 +    %let dsid = %sysfunc(close(&dsid));
15877 +   %doendo:
15878 +%mend makeNewVarOptCode;
15879 +
15880 +%macro makeClassScoreCode(LevelData=, nameData=_newNames);
15881 +   %let UFormatFlag = 0;
15882 +
15883 +   %em_register(key=REPLACECODE, type=FOLDER);
15884 +
15885 +   /* Generating New Variable Score Code */
15886 +   %makeNewVarCode(ScoreFile=&EM_FILE_EMFLOWSCORECODE,  Data=&nameData);
15887 +
15888 +   data _tempNewVars;
15889 +      set &nameData;
15890 +      where ROLE ne 'TARGET';
15891 +   run;
15892 +   %makeNewVarCode(ScoreFile=&EM_FILE_EMPUBLISHSCORECODE, Data=_tempNewVars);
15893 +   %makeNewVarOptCode(Folder=&em_user_replacecode, Data=_tempNewVars);
15894 +
15895 +   proc datasets lib=WORK nolist;
15896 +      delete _tempNewVars;
15897 +   run;
15898 +   quit;
15899 +
15900 +   /* Generating Publish Score Code */
15901 +   data _temp;
15902 +      set &LevelData;
15903 +      where ROLE ne 'TARGET' and LEVEL='_UNKNOWN_' and (REPLACE_VALUE ^in('', '_DEFAULT_') or
15904 +                             (REPLACE_VALUE='_DEFAULT_' and UNKWOWNDEFAULT ne 'NONE'));
15905 +      keep NAME;
15906 +   run;
15907 +
15908 +   data _temp;
15909 +      merge _temp(in=_a) &Leveldata &nameData;
15910 +      by NAME;
15911 +      if _a then output;
15912 +   run;
15913 +
15914 +   %makeUnknownCode(ScoreFile=&EM_FILE_EMPUBLISHSCORECODE, Data=_temp);
15915 +   %makeUnknownOptCode(Folder=&em_user_replacecode,        Data=_temp);
15916 +   proc datasets lib=work nolist;
15917 +      delete _temp;
15918 +   run;
15919 +   quit;
15920 +
15921 +   data _temp;
15922 +      merge &LevelData(in=_a where=( ROLE ne 'TARGET' and LEVEL ne '_UNKNOWN_' and
15923 +        (REPLACE_VALUE ^in('', '_DEFAULT_') or (REPLACE_VALUE='_DEFAULT_' and UNKWOWNDEFAULT ne 'NONE')) ))  &nameData;
15924 +      by NAME;
15925 +      if _a then output;
15926 +   run;
15927 +
15928 +   %makeReplaceCode(ScoreFile=&EM_FILE_EMPUBLISHSCORECODE, Data=_temp);
15929 +   %makeReplaceOptCode(Folder=&em_user_replacecode,        Data=_temp);
15930 +
15931 +   /* Generating Flow Score Code */
15932 +   data _temp;
15933 +      set &LevelData;
15934 +      where LEVEL='_UNKNOWN_' and (REPLACE_VALUE ^in('', '_DEFAULT_') or
15935 +                             (REPLACE_VALUE='_DEFAULT_' and UNKWOWNDEFAULT ne 'NONE'));
15936 +      keep NAME;
15937 +   run;
15938 +
15939 +   data _temp;
15940 +      merge _temp(in=_a) &Leveldata &nameData;
15941 +      by NAME;
15942 +      if _a then output;
15943 +   run;
15944 +   %makeUnknownCode(ScoreFile=&EM_FILE_EMFLOWSCORECODE, Data=_temp);
15945 +
15946 +   data _temp;
15947 +      merge &LevelData(in=_a where=(LEVEL ne '_UNKNOWN_' and (REPLACE_VALUE ^in('', '_DEFAULT_') or
15948 +                             (REPLACE_VALUE='_DEFAULT_' and UNKWOWNDEFAULT ne 'NONE')) )) &nameData;
15949 +      by NAME;
15950 +      if _a then output;
15951 +   run;
15952 +
15953 +   %makeReplaceCode(ScoreFile=&EM_FILE_EMFLOWSCORECODE, Data=_temp);
15954 +
15955 +   %if "&UFormatFlag" = "1" %then %do;
15956 +       filename _F1 "&em_user_replacecode&em_dsep._ALL_.sas" MOD;
15957 +       data _null_;
15958 +          file _F1;
15959 +          put 'length _UFormat200 $200;';
15960 +          put 'drop   _UFORMAT200;';
15961 +          put '_UFORMAT200 = " ";';
15962 +       run;
15963 +       filename _F1;
15964 +   %end;
15965 +
15966 +%mend makeClassScoreCode;
15967 +
15968 +%macro makeClassDeltaCode(nameData=_newNames);
15969 +   %if ^%sysfunc(exist(&nameData)) %then %goto doendm;
15970 +
15971 +   filename _F1 "&EM_FILE_CDELTA_TRAIN" MOD;
15972 +   data _null_;
15973 +        set &nameData end=eof;
15974 +        length string $400;
15975 +        file _F1;
15976 +        %if &EM_PROPERTY_HIDEVARIABLE eq Y %then %do;
15977 +            string = 'if NAME="'!!strip(NAME)!!'" then delete;';  put string;
15978 +        %end;
15979 +        %else %do;
15980 +            string = 'if NAME="'!!strip(NAME)!!'" then ROLE="REJECTED";'; put string;
15981 +        %end;
15982 +        put 'else';
15983 +        string = '   if NAME="'!!strip(NEWNAME)!!'" then do;'; put string;
15984 +        string = '      ROLE="'!!strip(ROLE)!!'";';            put string;
15985 +        string = '      LEVEL="'!!strip(MLEVEL)!!'";';         put string;
15986 +        put      'end;';
15987 +        if ^eof then
15988 +           put 'else';
15989 +   run;
15990 +   %doendm:
15991 +   filename _F1;
15992 +%mend makeClassDeltaCode;
15993 +
15994 +%macro makeValueReport(Data=, outData=);
15995 +   data &outData;
15996 +      set &data;
15997 +      where REPLACE_VALUE ^in('', '_DEFAULT_') or (REPLACE_VALUE eq '_DEFAULT_' and UNKWOWNDEFAULT ne 'NONE');
15998 +      if LEVEL = '_UNKNOWN_' then do;
15999 +         LEVEL='Unknown';
16000 +         %if &EM_PROPERTY_UNKNOWNLEVEL = MODE %then %do;
16001 +         if REPLACE_VALUE in('_MODE_', '_DEFAULT_') then REPLACE_VALUE = strip(NORMMODE);
16002 +         else
16003 +            if REPLACE_VALUE ='_MISSING_' then do;
16004 +               if type eq 'N' then REPLACE_VALUE='.';
16005 +               else REPLACE_VALUE='_blank_';
16006 +            end;
16007 +         %end;
16008 +         %else  %do;
16009 +         if REPLACE_VALUE = '_MODE_' then REPLACE_VALUE = strip(NORMMODE);
16010 +         else
16011 +            if REPLACE_VALUE in('_MISSING_', '_DEFAULT_') then do;
16012 +               if type eq 'N' then REPLACE_VALUE='.';
16013 +               else REPLACE_VALUE='_blank_';
16014 +            end;
16015 +         %end;
16016 +      end;
16017 +      else do;
16018 +         if REPLACE_VALUE ='_MISSING_' then do;
16019 +            if type eq 'N' then REPLACE_VALUE='.';
16020 +            else REPLACE_VALUE='_blank_';
16021 +         end;
16022 +         else
16023 +            if REPLACE_VALUE = '_MODE_' then REPLACE_VALUE = strip(NORMMODE);
16024 +      end;
16025 +      keep NAME LEVEL CRAW NRAW REPLACE_VALUE TYPE LABEL ;
16026 +   run;
16027 +%mend makeValueReport;
16028 +
16029 +%macro makeVarOptCode(LimitDs=, Folder=);
16030 +    %if ^%sysfunc(exist(&LimitDs)) or "&Folder" eq "" %then %goto doendo;
16031 +
16032 +    %let dsid = %sysfunc(open(&limitDs));
16033 +    %do %while(^%sysfunc(fetch(&dsid)));
16034 +        %let newNum     = %sysfunc(varnum(&dsid, NewName));
16035 +        %let newname = %sysfunc(getvarc(&dsid, &newNum));
16036 +
16037 +    filename sfile "&Folder.&em_dsep.&newname..sas";
16038 +    data _null_;
16039 +       length string $400;
16040 +       set &LimitDs;
16041 +       where NEWNAME="&newname";
16042 +       file sfile;
16043 +       put '* ;';
16044 +       string = '*Variable: '!!strip(name)!!';';
16045 +       put string;
16046 +       put '* ;';
16047 +       if label eq '' then
16048 +          string = 'Label '!!strip(newname)!!"= 'Replacement: "!!strip(name)!!"';";
16049 +       else
16050 +          string = 'Label '!!strip(newname)!!"= 'Replacement: "!!strip(tranwrd(label, "'", "''"))!!"';";
16051 +       put string;
16052 +       string = strip(newname)!!'= '!!strip(NAME)!!';';
16053 +       put string;
16054 +       replacemin = .;
16055 +       string = 'if '!!strip(name)!!' eq . then '!!strip(newname)!!' = .;';
16056 +       put string;
16057 +       if LowerLimit ne . then do;
16058 +          if ReplaceMethodUsed="COMPUTED" then replaceMin=LowerLimit;
16059 +          if ReplaceMethodUsed="MANUAL"   then replaceMin = ReplaceMinUsed;
16060 +          put 'else';
16061 +          string = 'if '!!strip(name)!!'<'!!strip(put(lowerlimit,best.))
16062 +                    !!' then '!!strip(newname)!!'='!!strip(put(replaceMin,best.))!!';';
16063 +          put string;
16064 +       end;
16065 +       if UpperLimit ne . then do;
16066 +          if ReplaceMethodUsed="COMPUTED" then replaceMax=UpperLimit;
16067 +          if ReplaceMethodUsed="MANUAL"   then replaceMax = ReplaceMaxUsed;
16068 +          put 'else';
16069 +          string = 'if '!!strip(name)!!'>'!!strip(put(upperlimit,best.))
16070 +                    !!' then '!!strip(newname)!!'='!!strip(put(replaceMax,best.))!!';';
16071 +          put string;
16072 +       end;
16073 +        run;
16074 +        filename sfile;
16075 +    %end;
16076 +    %let dsid = %sysfunc(close(&dsid));
16077 +
16078 +    %doendo:
16079 +%mend makeVarOptCode;
16080 +
16081 +%macro score;
16082 +   %em_register(key=REPLACECODE, type=FOLDER);
16083 +
16084 +   filename x catalog 'sashelp.emutil.em_deldir.source';
16085 +   %inc x;
16086 +   filename x;
16087 +   %delDir(folder=%nrbquote(&em_user_replacecode));
16088 +
16089 +   data _null_; length rc $200;
16090 +      rc = dcreate('REPLACECODE', "&EM_NODEDIR");
16091 +   run;
16092 +
16093 +   filename _F1 "&EM_FILE_EMFLOWSCORECODE";
16094 +   filename _F2 "&EM_FILE_EMPUBLISHSCORECODE";
16095 +   filename _F3 "&EM_FILE_CDELTA_TRAIN";
16096 +   data _null_;
16097 +      rc=fdelete('_F1');
16098 +      rc=fdelete('_F2');
16099 +      rc=fdelete('_F3');
16100 +   run;
16101 +   filename _F1;
16102 +   filename _F2;
16103 +   filename _F3;
16104 +
16105 +   %em_getname(key=OUTCLASS,  type=DATA);
16106 +   %em_getname(key=LIMITS, type=DATA);
16107 +   %em_getname(key=CLASSINFO, type=DATA);
16108 +
16109 +   /* Retrieve Replacement Values for Class Variables */
16110 +   %makeLevelData(outclass=&em_user_outclass, data=CLASSTEMP);
16111 +
16112 +   /* Generate Names for Replaced Variables */
16113 +   %makeNewNames(limitDs =&em_user_limits, classValue=CLASSTEMP, classname=&em_user_classinfo);
16114 +
16115 +   /* Generate score and delta code for Var Variables */
16116 +   %if %sysfunc(exist(&EM_USER_LIMITS)) %then %do;
16117 +       %makeVarScoreCode(LimitDs = &EM_USER_LIMITS, File=&EM_FILE_EMFLOWSCORECODE);
16118 +       %makeVarScoreCode(LimitDs = &EM_USER_LIMITS, File=&EM_FILE_EMPUBLISHSCORECODE);
16119 +       %makeVarOptCode(LimitDs= &EM_USER_LIMITS,    Folder=&em_user_replacecode);
16120 +       %makeVarDeltaCode(LimitDs = &EM_USER_LIMITS);
16121 +
16122 +       proc print data=&EM_USER_LIMITS label noobs;
16123 +          var Name newname lowerLimit REPLACEMINUSED UpperLimit REPLACEMAXUSED;
16124 +          label REPLACEMINUSED  =  "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemin_vlabel, NOQUOTE))"
16125 +                REPLACEMAXUSED  =  "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemax_vlabel, NOQUOTE))";
16126 +          title9  ' ';
16127 +          title10 "%sysfunc(sasmsg(sashelp.dmine, rpt_varlimits_title, NOQUOTE))";
16128 +       run;
16129 +       title10;
16130 +  %end;
16131 +
16132 +   %if %sysfunc(exist(&EM_USER_CLASSINFO)) %then %do;
16133 +       %makeClassScoreCode(LevelData=CLASSTEMP, nameData=&em_user_classinfo);
16134 +       %makeClassDeltaCode(nameData=&em_user_classinfo);
16135 +   %end;
16136 +
16137 +   %em_getname(key=VALUES, type=DATA);
16138 +   %makeValueReport(data=CLASSTEMP, outData=&EM_USER_VALUES);
16139 +   %if %sysfunc(exist(&EM_USER_VALUES)) %then %do;
16140 +       %let nobs = 0;
16141 +       %let dsid = %sysfunc(open(&EM_USER_VALUES));
16142 +       %if &dsid %then %do;
16143 +           %let nobs =  %sysfunc(attrn(&dsid, NOBS));
16144 +           %let dsid = %sysfunc(close(&dsid));
16145 +       %end;
16146 +       %if &nobs %then
16147 +           %EM_REPORT(key=VALUES, viewtype=DATA, block=MODEL, description=ReplaceLevels,autoDisplay=N);
16148 +   %end;
16149 +
16150 +   %if %sysfunc(exist(&EM_USER_VALUES)) %then %do;
16151 +       proc print data=&EM_USER_VALUES label noobs;
16152 +          title9  ' ';
16153 +          title10 "%sysfunc(sasmsg(sashelp.dmine, rpt_classreplacement_title, NOQUOTE))";
16154 +      run;
16155 +      title10;
16156 +  %end;
16157 +
16158 +   proc datasets lib=work nolist;
16159 +      delete CLASSTEMP;
16160 +   run;
16161 +   quit;
16162 +
16163 +   %em_register(key=EMSCOREVAR, type=DATA);
16164 +   %let scorevarDs = %scan(&em_user_emscorevar, 2, .);
16165 +   proc datasets lib=&em_lib nolist;
16166 +      delete &scorevarDs;
16167 +   run;
16168 +   quit;
16169 +
16170 +   %let filrf=mydir;
16171 +   %let rc=%sysfunc(filename(filrf,&em_user_replacecode));
16172 +   %let did=%sysfunc(dopen(&filrf));
16173 +
16174 +   %if &did %then %do;
16175 +       %let memcount=%sysfunc(dnum(&did));
16176 +       %if &memcount > 0 %then %do;
16177 +           data &em_user_emscorevar;
16178 +              length Name $32 formula $70 file $200;
16179 +              keep NAME Formula file;
16180 +
16181 +           %if %sysfunc(fileexist(&em_user_replacecode&em_dsep._ALL_.sas)) %then %do;
16182 +               name=''; file="REPLACECODE&em_dsep._ALL_.sas";
16183 +               output;
16184 +           %end;
16185 +           %do i=1 %to &memcount;
16186 +               %let name =%nrbquote(%sysfunc(dread(&did,&i)));
16187 +               %let newvar = %scan(&name, 1, .);
16188 +               %if "&newvar" ne "_ALL_" %then %do;
16189 +                   name = "&newvar"; file="REPLACECODE&em_dsep&name";
16190 +                   output;
16191 +               %end;
16192 +           %end;
16193 +           run;
16194 +       %end;
16195 +  %end;
16196 +  %if &did %then %let did = %sysfunc(dclose(&did));
16197 +
16198 +
16199 +%mend score;
NOTE: %INCLUDE (level 1) ending.
NOTE: Fileref TEMP has been deassigned.
 
NOTE: The data set WORK.EM_USER_KEY has 1 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
NOTE: %INCLUDE (level 1) file X is file SASHELP.EMUTIL.EM_DELDIR.SOURCE.
16200 +%macro delDir(folder=);
16201 +   %let filrf=mydir;
16202 +   %let rc=%sysfunc(filename(filrf,&folder));
16203 +   %let did=%sysfunc(dopen(&filrf));
16204 +
16205 +   %if &did %then %do;
16206 +       %let memcount=%sysfunc(dnum(&did));
16207 +       %if &memcount > 0 %then %do;
16208 +           %do i=1 %to &memcount;
16209 +               %let name =%nrbquote(%sysfunc(dread(&did,&i)));
16210 +               data _null_;
16211 +                  fname="_temp&i";
16212 +                  rc=filename(fname,"&folder&em_dsep.&name");
16213 +                  if rc = 0 and fexist(fname) then
16214 +                     rc=fdelete(fname);
16215 +                  rc=filename(fname);
16216 +               run;
16217 +           %end;
16218 +       %end;
16219 +       %let rc=%sysfunc(dclose(&did));
16220 +   %end;
16221 +   %let rc = %sysfunc(fdelete(&filrf));
16222 +   %let rc=%sysfunc(filename(filrf));
16223 +%mend delDir;
NOTE: %INCLUDE (level 1) ending.
NOTE: Fileref X has been deassigned.
 
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
NOTE: Fileref _F2 has been deassigned.
NOTE: Fileref _F3 has been deassigned.
 
WARNING: The variable UNKWOWNDEFAULT in the DROP, KEEP, or RENAME list has never been referenced.
NOTE: There were 75 observations read from the data set EMWS2.REPL_OUTCLASS.
NOTE: The data set WORK.REPLACE_MODE has 6 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: Input data set is already sorted, no sorting done.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
WARNING: Multiple lengths were specified for the BY variable Name by input data sets. This might cause unexpected results.
NOTE: There were 75 observations read from the data set EMWS2.REPL_OUTCLASS.
NOTE: There were 6 observations read from the data set WORK.REPLACE_MODE.
NOTE: There were 6 observations read from the data set EMWS2.REPL_VARIABLESET.
      WHERE MLEVEL not = 'INTERVAL';
NOTE: The data set WORK.CLASSTEMP has 75 observations and 16 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: Deleting WORK.REPLACE_MODE (memtype=DATA).
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.CLASSTEMP.
      WHERE REPLACE_VALUE not in (' ', '_DEFAULT_') or ((REPLACE_VALUE='_DEFAULT_') and (UNKWOWNDEFAULT not = 'NONE'));
NOTE: 0 observations with duplicate key values were deleted.
NOTE: The data set WORK.INVARNAME has 1 observations and 16 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.INVARNAME.
NOTE: The data set WORK.INVARNAME has 1 observations and 1 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.INVARNAME.
NOTE: The data set WORK.OUTNAME has 1 observations and 2 variables.
NOTE: PROCEDURE DMDB used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.OUTNAME.
NOTE: The data set WORK.OUTNAME has 1 observations and 2 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: There were 75 observations read from the data set WORK.CLASSTEMP.
NOTE: The data set WORK.LENGTH has 6 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.OUTNAME.
NOTE: There were 6 observations read from the data set WORK.LENGTH.
NOTE: The data set EMWS2.REPL_CLASSINFO has 1 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.04 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: Deleting WORK.LENGTH (memtype=DATA).
NOTE: Deleting WORK.INVARNAME (memtype=DATA).
NOTE: Deleting WORK.OUTNAME (memtype=DATA).
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.EM_USER_KEY.
NOTE: The data set WORK.EM_USER_KEY has 2 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMFLOWSCORE.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=0,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 7 records were written to the file _F1.
      The minimum record length was 3.
      The maximum record length was 42.
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
      WHERE ROLE not = 'TARGET';
NOTE: The data set WORK._TEMPNEWVARS has 1 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMPUBLISHSCORE.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=0,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 7 records were written to the file _F1.
      The minimum record length was 3.
      The maximum record length was 42.
NOTE: There were 1 observations read from the data set WORK._TEMPNEWVARS.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK._TEMPNEWVARS.
NOTE: The data set WORK._TEMP_ has 1 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\REPLACECODE\REP_DemGender.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=0,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 7 records were written to the file _F1.
      The minimum record length was 3.
      The maximum record length was 42.
NOTE: There were 1 observations read from the data set WORK._TEMPNEWVARS.
      WHERE NEWNAME='REP_DemGender';
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
NOTE: Deleting WORK._TEMPNEWVARS (memtype=DATA).
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 0 observations read from the data set WORK.CLASSTEMP.
      WHERE (ROLE not = 'TARGET') and (LEVEL='_UNKNOWN_') and (REPLACE_VALUE not in (' ', '_DEFAULT_') or ((REPLACE_VALUE='_DEFAULT_') and (UNKWOWNDEFAULT not = 'NONE')));
NOTE: The data set WORK._TEMP has 0 observations and 1 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: There were 0 observations read from the data set WORK._TEMP.
NOTE: There were 75 observations read from the data set WORK.CLASSTEMP.
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
NOTE: The data set WORK._TEMP has 0 observations and 17 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMPUBLISHSCORE.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=139,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 0 records were written to the file _F1.
NOTE: There were 0 observations read from the data set WORK._TEMP.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
 
NOTE: Deleting WORK._TEMP (memtype=DATA).
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.CLASSTEMP.
      WHERE (ROLE not = 'TARGET') and (LEVEL not = '_UNKNOWN_') and (REPLACE_VALUE not in (' ', '_DEFAULT_') or ((REPLACE_VALUE='_DEFAULT_') and (UNKWOWNDEFAULT not = 'NONE')));
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
NOTE: The data set WORK._TEMP has 1 observations and 17 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMPUBLISHSCORE.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=139,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 13 records were written to the file _F1.
      The minimum record length was 3.
      The maximum record length was 33.
NOTE: There were 1 observations read from the data set WORK._TEMP.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\REPLACECODE\REP_DemGender.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=138,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 6 records were written to the file _F1.
      The minimum record length was 3.
      The maximum record length was 31.
NOTE: There were 1 observations read from the data set WORK._TEMP.
      WHERE NAME='DemGender';
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
 
NOTE: There were 0 observations read from the data set WORK.CLASSTEMP.
      WHERE (LEVEL='_UNKNOWN_') and (REPLACE_VALUE not in (' ', '_DEFAULT_') or ((REPLACE_VALUE='_DEFAULT_') and (UNKWOWNDEFAULT not = 'NONE')));
NOTE: The data set WORK._TEMP has 0 observations and 1 variables.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 0 observations read from the data set WORK._TEMP.
NOTE: There were 75 observations read from the data set WORK.CLASSTEMP.
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
NOTE: The data set WORK._TEMP has 0 observations and 17 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMFLOWSCORE.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=139,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 0 records were written to the file _F1.
NOTE: There were 0 observations read from the data set WORK._TEMP.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
 
NOTE: There were 1 observations read from the data set WORK.CLASSTEMP.
      WHERE (LEVEL not = '_UNKNOWN_') and (REPLACE_VALUE not in (' ', '_DEFAULT_') or ((REPLACE_VALUE='_DEFAULT_') and (UNKWOWNDEFAULT not = 'NONE')));
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
NOTE: The data set WORK._TEMP has 1 observations and 17 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMFLOWSCORE.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=139,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 13 records were written to the file _F1.
      The minimum record length was 3.
      The maximum record length was 33.
NOTE: There were 1 observations read from the data set WORK._TEMP.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\REPLACECODE\_ALL_.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=0,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 3 records were written to the file _F1.
      The minimum record length was 18.
      The maximum record length was 24.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\CDELTA_TRAIN.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=0,
      Last Modified=11Dec2017:23:08:27,
      Create Time=11Dec2017:23:08:27
 
NOTE: 6 records were written to the file _F1.
      The minimum record length was 4.
      The maximum record length was 41.
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
NOTE: DATA statement used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
NOTE: Fileref _F1 has been deassigned.
 
NOTE: There were 1 observations read from the data set WORK.CLASSTEMP.
      WHERE REPLACE_VALUE not in (' ', '_DEFAULT_') or ((REPLACE_VALUE='_DEFAULT_') and (UNKWOWNDEFAULT not = 'NONE'));
NOTE: The data set EMWS2.REPL_VALUES has 1 observations and 7 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The data set WORK.EM_USER_REPORT has 132 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
NOTE: There were 1 observations read from the data set EMWS2.REPL_VALUES.
NOTE: The PROCEDURE PRINT printed page 1.
NOTE: PROCEDURE PRINT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: Deleting WORK.CLASSTEMP (memtype=DATA).
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 2 observations read from the data set WORK.EM_USER_KEY.
NOTE: The data set WORK.EM_USER_KEY has 3 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The file EMWS2.REPL_EMSCOREVAR (memtype=DATA) was not found, but appears on a DELETE statement.
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: Variable formula is uninitialized.
NOTE: The data set EMWS2.REPL_EMSCOREVAR has 2 observations and 3 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.01 seconds
 
 
16224  *------------------------------------------------------------*;
16225  * End SCORE: Repl;
16226  *------------------------------------------------------------*;
16227
 
16228  filename emflow "\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMFLOWSCORE.sas";
16229  *------------------------------------------------------------*;
16230  * Repl: Scoring DATA data;
16231  *------------------------------------------------------------*;
16232  data EMWS2.Repl_TRAIN
16233  / view=EMWS2.Repl_TRAIN
16234  ;
16235  set EMWS2.Stat_TRAIN
16236  ;
16237  %inc emflow;
NOTE: %INCLUDE (level 1) file EMFLOW is file \\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\EMFLOWSCORE.sas.
16238 +
16239 +* ;
16240 +* Defining New Variables;
16241 +* ;
16242 +Length REP_DemGender $9;
16243 +Label REP_DemGender='Replacement: Gender';
16244 +REP_DemGender= DemGender;
16245 +
16246 +* ;
16247 +* Replace Specific Class Levels ;
16248 +* ;
16249 +length _UFormat200 $200;
16250 +drop   _UFORMAT200;
16251 +_UFORMAT200 = " ";
16252 +* ;
16253 +* Variable: DemGender;
16254 +* ;
16255 +_UFORMAT200 = strip(DemGender);
16256 +if _UFORMAT200 =  "U" then
16257 +REP_DemGender="_UNKNOWN_";
NOTE: %INCLUDE (level 1) ending.
16258  run;
 
NOTE: DATA STEP view saved on file EMWS2.REPL_TRAIN.
NOTE: A stored DATA STEP view cannot run under a different operating system.
NOTE: View EMWS2.STAT_TRAIN.VIEW used (Total process time):
      real time           0.07 seconds
      cpu time            0.07 seconds
 
NOTE: DATA statement used (Total process time):
      real time           0.10 seconds
      cpu time            0.10 seconds
 
 
16259  quit;
16260  filename emflow;
NOTE: Fileref EMFLOW has been deassigned.
 
16262  proc sort data=WORK.EM_USER_REPORT;
16263  by ID VIEW;
16264  run;
 
NOTE: There were 132 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 132 observations and 4 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
16265  *------------------------------------------------------------*;
16266  * Repl: Computing metadata for TRAIN data;
16267  *------------------------------------------------------------*;
 
NOTE: View EMWS2.REPL_TRAIN.VIEW used (Total process time):
      real time           0.09 seconds
      cpu time            0.09 seconds
 
NOTE: View EMWS2.REPL_TRAIN.VIEW used (Total process time):
      real time           0.09 seconds
      cpu time            0.09 seconds
 
*------------------------------------------------------------*
* Report Log
Date:                December 11, 2017
Time:                23:08:27
*------------------------------------------------------------*
16634  %let EMEXCEPTIONSTRING=;
16635  *------------------------------------------------------------*;
16636  * REPORT: Repl;
16637  *------------------------------------------------------------*;
16638  %let EM_ACTION = REPORT;
16639  %let syscc = 0;
16640  filename x CATALOG 'SASHELP.EMUTIL.EM_VARMACRO.SOURCE';
16641  %inc x;
NOTE: %INCLUDE (level 1) file X is file SASHELP.EMUTIL.EM_VARMACRO.SOURCE.
16643 +%macro em_varMacro(name=emMacro, metadata=, where=, key=NAME, nummacro=, maxvar=-1);
16645 +   filename macFile catalog 'work.emutil.macro.source';
16646 +   %let _METAOBS = 0;
16647 +   %let _maxvar = &maxvar;
16648 +   %if "&_maxvar" eq "" %then %let maxvar = -1;
16650 +   %if (%sysfunc(exist(&metadata))<1 and %sysfunc(exist(&metadata, VIEW))<1)
16651 +                   or (&metadata eq ) %then %do;
16652 +       %put * No metadata data set defined;
16653 +       %goto doend;
16654 +   %end;
16656 +   data _null_;
16657 +      length _STRING_ $80;
16658 +      retain _STRING_ '' maxvar 0;
16659 +      set &metadata end=eof;
16660 +      file macFile;
16661 +      %if %nrbquote(&where) ne %then %do;
16662 +          %let whereClause = where (%nrbquote(&where));
16663 +          %unquote(&whereClause);
16664 +      %end;
16665 +      if _N_=1 then do;
16666 +         string = "%"!!"macro &name;";
16667 +         put string;
16668 +      end;
16669 +      maxvar +1;
16670 +      if (length(_STRING_) + length(trim(&key))+ 4 < 80) then do;
16671 +         _STRING_ = trim(_STRING_)!!' '!!trim(&key);
16672 +         if eof
16673 +            %if  %sysevalf(&_maxvar > 0) %then %do;
16674 +                or maxvar >= &maxvar
16675 +            %end;
16676 +            then do;
16677 +            put _STRING_;
16678 +            string = "%"!!"mend &name;";
16679 +            put string;
16680 +            string = strip(put(_N_, best.));
16681 +            call symput('_METAOBS', string);
16682 +            %if (&nummacro ne ) %then %do;
16683 +                put "%" "global &nummacro;";
16684 +                put "%" "let &nummacro = " string ";";
16685 +            %end;
16686 +            stop;
16687 +         end;
16688 +      end;
16689 +      else do;
16690 +         put _STRING_;
16691 +         _string_ = TRIM(&key);
16692 +         if eof
16693 +            %if  %sysevalf(&_maxvar > 0) %then %do;
16694 +              or maxvar >= &maxvar
16695 +           %end;
16696 +            then do;
16697 +            put _STRING_;
16698 +            string = "%"!!"mend &name;";
16699 +            put string;
16700 +        end;
16701 +      end;
16702 +      if eof
16703 +         %if  %sysevalf(&_maxvar > 0) %then %do;
16704 +             or maxvar >= &maxvar
16705 +         %end;
16706 +         then do;
16707 +         string = strip(put(_N_, best.));
16708 +         call symput('_METAOBS', string);
16709 +         %if (&nummacro ne ) %then %do;
16710 +             put "%" "global &nummacro;";
16711 +             put "%" "let &nummacro = " string ";";
16712 +         %end;
16713 +         stop;
16714 +      end;
16715 +   run;
16717 +   %doend:
16718 +   %if ^&_METAOBS %then %do;
16719 +       data _null_;
16720 +          file macFile;
16721 +          put "%" "macro &name;";
16722 +          put "%" "mend &name;";
16723 +          %if (&nummacro ne ) %then %do;
16724 +              put "%" "global &nummacro;";
16725 +              put "%" "let &nummacro = 0;";
16726 +          %end;
16727 +      run;
16728 +   %end;
16729 +   %inc macFile;
16730 +   filename macFile;
16731 +%mend em_varMacro;
NOTE: %INCLUDE (level 1) ending.
16732  filename X;
NOTE: Fileref X has been deassigned.
16733   %macro main;
16734
16735     filename temp catalog 'sashelp.emmdfy.Replace_macros.source';
16736     %include temp;
16737     filename temp;
16738
16739     %if %upcase(&EM_ACTION) = CREATE %then %do;
16740
16741         filename temp catalog 'sashelp.emmdfy.Replace_create.source';
16742         %include temp;
16743         filename temp;
16744         %create;
16745     %end;
16746     %else
16747     %if %upcase(&EM_ACTION) = TRAIN %then %do;
16748
16749         filename temp catalog 'sashelp.emmdfy.Replace_train.source';
16750         %include temp;
16751         filename temp;
16752         %train;
16753     %end;
16754     %else
16755     %if %upcase(&EM_ACTION) = SCORE %then %do;
16756
16757         filename temp catalog 'sashelp.emmdfy.Replace_score.source';
16758         %include temp;
16759         filename temp;
16760         %score;
16761     %end;
16762     %if %upcase(&EM_ACTION) = REPORT %then %do;
16763
16764         filename temp catalog 'sashelp.emmdfy.Replace_report.source';
16765         %include temp;
16766         filename temp;
16767         %report;
16768     %end;
16769     %if %upcase(&EM_ACTION) = OPENOUTCLASSTABLE %then %do;
16770         filename temp catalog 'sashelp.emmdfy.replace_makeoutclass.source';
16771         %include temp;
16772         filename temp;
16773         %em_replace_openoutclass;
16774     %end;
16775     %if %upcase(&EM_ACTION) = CLOSEOUTCLASSTABLE %then %do;
16776         filename temp catalog 'sashelp.emmdfy.replace_makeoutclass.source';
16777         %include temp;
16778         filename temp;
16779         %em_replace_closeoutclass;
16780     %end;
16781  %mend main;
16782
16783  %main;
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMMDFY.REPLACE_MACROS.SOURCE.
16784 +%macro SetProperties;
16785 +   %em_checkmacro(name=EM_PROPERTY_UNKNOWNLEVEL,    global=Y, value=MODE);
16786 +   %em_checkmacro(name=EM_PROPERTY_CALCMETHOD,      global=Y, value=NONE);
16787 +   %em_checkmacro(name=EM_PROPERTY_PERCENTSCUTOFF,  global=Y, value=0.5);
16788 +   %em_checkmacro(name=EM_PROPERTY_SPACINGSCUTOFF,  global=Y, value=9);
16789 +   %em_checkMacro(name=EM_PROPERTY_MADSCUTOFF,      global=Y, value=9);
16790 +   %em_checkMacro(name=EM_PROPERTY_STDDEVCUTOFF,    global=Y, value=3);
16791 +   %em_checkmacro(name=EM_PROPERTY_REPLACEMETHOD,   global=Y, value=COMPUTED);
16792 +   %em_checkmacro(name=EM_PROPERTY_HIDEVARIABLE,    global=Y, value=N);
16793 +   %em_checkmacro(name=EM_PROPERTY_INTERVALMETHOD,  global=Y, value=NONE);
16794 +   %em_checkmacro(name=EM_PROPERTY_REPORTCOUNT,     global=Y, value=Y);
16795 +
16796 +%mend SetProperties;
16797 +
NOTE: %INCLUDE (level 1) ending.
NOTE: Fileref TEMP has been deassigned.
NOTE: %INCLUDE (level 1) file TEMP is file SASHELP.EMMDFY.REPLACE_REPORT.SOURCE.
16798 +%macro makeNameDs(namedata=, limitDs=, classname=);
16799 +    %let classnum=0;
16800 +    %let dsid = %sysfunc(open(&classname));
16801 +    %if &dsid>0 %then %do;
16802 +        %let classnum = %sysfunc(attrn(&dsid, NOBS));
16803 +        %let dsid = %sysfunc(close(&dsid));
16804 +    %end;
16805 +
16806 +    %let varnum=0;
16807 +    %let dsid = %sysfunc(open(&LimitDs));
16808 +    %if &dsid>0 %then %do;
16809 +        %let varnum = %sysfunc(attrn(&dsid, NOBS));
16810 +        %let dsid = %sysfunc(close(&dsid));
16811 +    %end;
16812 +    %if ^&varnum and  ^&classnum %then %goto doendmnd;
16813 +
16814 +    data &nameData;
16815 +       set
16816 +       %if &varnum %then %do;
16817 +          &limitDs
16818 +      %end;
16819 +      %if &classnum %then %do;
16820 +          &classname
16821 +      %end;
16822 +    ;
16823 +    run;
16824 +    proc sort data=&nameData;
16825 +       by name;
16826 +    run;
16827 +
16828 +    %doendmnd:
16829 +%mend makeNameDs;
16830 +
16831 +%macro countReplace(FileRef1=, dataRole=, data=, CountData=);
16832 +   %if (^%sysfunc(exist(&data)) and ^%sysfunc(exist(&data, VIEW))) or (&data eq ) %then %goto doendm;
16833 +
16834 +   data _temp;
16835 +      length DataRole $8;
16836 +      DataRole ="&DataRole";
16837 +      array _ReplaceCount{&ReplaceNum} (
16838 +      %do i=1 %to &ReplaceNum;
16839 +          0
16840 +      %end;
16841 +      );
16842 +      array _DIFF{&ReplaceNum};
16843 +      retain _ReplaceCount1 -- _ReplaceCount&ReplaceNum;
16844 +      set &data end=eof;
16845 +      %inc &FileRef1;
16846 +      do i=1 to &ReplaceNum;
16847 +         if _DIFF(i) then _ReplaceCount(i) = _ReplaceCount(i)+1;
16848 +      end;
16849 +      keep DataRole _ReplaceCount:;
16850 +      if eof then
16851 +         output;
16852 +   run;
16853 +   proc append base=&CountData data=_temp;
16854 +   run;
16855 +   proc datasets lib=WORK nolist;
16856 +      delete _temp;
16857 +   run;
16858 +
16859 +   %doendm:
16860 +
16861 +%mend;
16862 +
16863 +%macro makeCountReport(nameData=, outData=countData);
16864 +   %if ^%sysfunc(exist(&nameData))%then %goto doendmc;
16865 +
16866 +   %global ReplaceNum;
16867 +   %let ReplaceNum=0;
16868 +   %let dsid = %sysfunc(open(&namedata));
16869 +   %if &dsid>0 %then %do;
16870 +       %let ReplaceNum = %sysfunc(attrn(&dsid, NOBS));
16871 +       %let dsid = %sysfunc(close(&dsid));
16872 +   %end;
16873 +   %if ^&ReplaceNum %then %goto doendmc;
16874 +
16875 +   %EM_REGISTER(key=DiffCode, TYPE=FILE, EXTENSION=sas);
16876 +   filename _F1 "&EM_USER_DiffCode";
16877 +
16878 +   data _null_;
16879 +      length string $200;
16880 +      set &namedata;
16881 +      file _F1;
16882 +      string = 'Label '!!'_ReplaceCount'!!strip(put(_N_,BEST.))!!' = "'!!strip(name)!!'";';
16883 +      put string;
16884 +      string = 'if '!!strip(NAME)!!' ne '!!strip(newname)!!' then ';
16885 +      put string;
16886 +      string = '_DIFF'!!strip(put(_N_,BEST.))!!'= 1;';
16887 +      put string;
16888 +      put ' else ';
16889 +      string = '_DIFF'!!strip(put(_N_,BEST.))!!'= 0;';
16890 +      put string;
16891 +   run;
16892 +   %countReplace(FileRef1=_F1, dataRole=Train, data=&EM_EXPORT_TRAIN,    CountData=_tempCount);
16893 +   %countReplace(FileRef1=_F1, dataRole=Valide,data=&EM_EXPORT_VALIDATE, CountData=_tempCount);
16894 +   %countReplace(FileRef1=_F1, dataRole=Test,  data=&EM_EXPORT_TEST,     CountData=_tempCount);
16895 +
16896 +   filename _F1;
16897 +
16898 +   %let validateFlag = 0;
16899 +   %let testFlag     = 0;
16900 +   %if (%sysfunc(exist(&EM_IMPORT_VALIDATE)) or %sysfunc(exist(&EM_IMPORT_VALIDATE, VIEW)))
16901 +                  and (&EM_IMPORT_VALIDATE ne ) %then %do;
16902 +        %let validateFlag = 1;
16903 +    %end;
16904 +    %if (%sysfunc(exist(&EM_IMPORT_TEST)) or %sysfunc(exist(&EM_IMPORT_TEST, VIEW)))
16905 +                    and (&EM_IMPORT_TEST ne ) %then %do;
16906 +          %let testFlag   = 1;
16907 +    %end;
16908 +
16909 +    proc transpose data=_tempCount out=&outData(drop=_NAME_ rename=(_LABEL_=NAME Col1=TRAIN
16910 +      %if &validateFlag = 1 %then %do;
16911 +          Col2=VALIDATE
16912 +      %end;
16913 +      %if &testFlag = 1 %then %do;
16914 +          Col3=TEST
16915 +      %end;
16916 +
16917 +      ));
16918 +   run;
16919 +
16920 +   %let lib = WORK;
16921 +   %if %index(&outData, .) %then %do;
16922 +       %let lib    = %scan(&outData, 1, .);
16923 +       %let member = %scan(&outData, 2, .);
16924 +   %end;
16925 +   %else
16926 +       %let member = &outData;
16927 +  proc sort data=&outdata;
16928 +     by name;
16929 +  run;
16930 +  data &outData;
16931 +      merge &namedata(keep=NAME ROLE LABEL) &outData;
16932 +      by NAME;
16933 +   run;
16934 +   proc datasets lib=&lib nolist;
16935 +      modify &member;
16936 +      label NAME =  "%sysfunc(sasmsg(sashelp.dmine, rpt_variable_vlabel, NOQUOTE))"
16937 +            ROLE =  "%sysfunc(sasmsg(sashelp.dmine, meta_role_vlabel   , NOQUOTE))"
16938 +            LABEL=  "%sysfunc(sasmsg(sashelp.dmine, meta_label_vlabel  , NOQUOTE))"
16939 +            TRAIN=  "%sysfunc(sasmsg(sashelp.dmine, rpt_train_vlabel   , NOQUOTE))"
16940 +      %if &validateFlag = 1 %then %do;
16941 +            VALIDATE= "%sysfunc(sasmsg(sashelp.dmine, rpt_validate_vlabel   , NOQUOTE))"
16942 +      %end;
16943 +      %if &testFlag = 1 %then %do;
16944 +            TEST= "%sysfunc(sasmsg(sashelp.dmine, rpt_test_vlabel   , NOQUOTE))"
16945 +      %end;
16946 +      ;
16947 +   run;
16948 +   proc print data=&em_user_count label;
16949 +      title9  ' ';
16950 +      title10 "%sysfunc(sasmsg(sashelp.dmine, rpt_replacecount_title, NOQUOTE))";
16951 +   run;
16952 +   title10;
16953 +   proc datasets lib=WORK nolist;
16954 +      delete _tempCount;
16955 +   run;
16956 +
16957 +  %doendmc:
16958 +%mend makeCountReport;
16959 +
16960 +%macro report;
16961 +   %em_getname(key=COUNT,        type=DATA);
16962 +   %em_getname(key=REPORTLIMITS, type=DATA);
16963 +   %em_getname(key=LIMITS,       type=DATA);
16964 +   %em_getname(key=CLASSINFO,    type=DATA);
16965 +
16966 +  /* Generating Reports */
16967 +   %let lib     = %scan(&EM_USER_COUNT, 1, .);
16968 +   %let member =;
16969 +   %if %sysfunc(exist(&em_user_reportlimits)) %then %let member = %scan(&EM_USER_REPORTLIMITS, 2, .);
16970 +   %if %sysfunc(exist(&em_user_count))        %then %let member = &member %scan(&EM_USER_count, 2, .);
16971 +   %if "&member" ne "" %then %do;
16972 +       proc datasets lib=&lib nolist;
16973 +         delete &member;
16974 +       run;
16975 +       quit;
16976 +   %end;
16977 +
16978 +   %let limitFlag = %sysfunc(exist(&em_user_limits));
16979 +    %if ^&limitFlag and  ^%sysfunc(exist(&em_user_classinfo)) %then %goto doendr;
16980 +
16981 +    %if &limitFlag %then %do;
16982 +        data &em_user_reportlimits;
16983 +           set &em_user_limits;
16984 +           label REPLACEMETHODUSED = "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemethod_vlabel, NOQUOTE))"
16985 +                 REPLACEMINUSED    = "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemin_vlabel, NOQUOTE))"
16986 +                 REPLACEMAXUSED    = "%sysfunc(sasmsg(sashelp.dmine, rpt_replacemax_vlabel, NOQUOTE))";
16987 +           drop ROLE LEVEL REPLACEMETHOD REPLACEMIN REPLACEMAX;
16988 +        run;
16989 +        %EM_REPORT(key=REPORTLIMITS,  viewtype=DATA, block=MODEL, description=ReplaceInterval, autoDisplay=Y);
16990 +    %end;
16991 +
16992 +    %if &em_property_CountReport=Y %then %do;
16993 +        %makeNameDs(namedata=newVarInfo, limitDs=&em_user_limits, classname=&em_user_classinfo);
16994 +
16995 +        %let labeloption = %sysfunc(getoption(label));
16996 +        options LABEL;run;
16997 +
16998 +        %makeCountReport(namedata=newVarInfo, outdata=&EM_USER_COUNT);
16999 +
17000 +        options &labeloption;run;
17001 +
17002 +        %EM_REPORT(key=COUNT, viewtype=DATA, block=MODEL, description=ReplaceCount, autoDisplay=Y);
17003 +   %end;
17004 +   proc datasets lib=WORK nolist;
17005 +      delete newVarInfo;
17006 +   run;
17007 +   %doendr:
17008 +%mend report;
NOTE: %INCLUDE (level 1) ending.
NOTE: Fileref TEMP has been deassigned.
 
NOTE: There were 1 observations read from the data set EMWS2.REPL_CLASSINFO.
NOTE: The data set WORK.NEWVARINFO has 1 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK.NEWVARINFO.
NOTE: The data set WORK.NEWVARINFO has 1 observations and 8 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 3 observations read from the data set WORK.EM_USER_KEY.
NOTE: The data set WORK.EM_USER_KEY has 4 observations and 8 variables.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: The file _F1 is:
      Filename=\\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\DiffCode.sas,
      RECFM=V,LRECL=32767,File Size (bytes)=0,
      Last Modified=11Dec2017:23:08:28,
      Create Time=11Dec2017:23:08:28
 
NOTE: 5 records were written to the file _F1.
      The minimum record length was 6.
      The maximum record length was 35.
NOTE: There were 1 observations read from the data set WORK.NEWVARINFO.
NOTE: DATA statement used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
 
 
NOTE: %INCLUDE (level 1) file _F1 is file \\filer.uncc.edu\home\hkatrag1\Project_lab\Predictive Analytics\Workspaces\EMWS2\Repl\DiffCode.sas.
17009 +Label _ReplaceCount1 = "DemGender";
17010 +if DemGender ne REP_DemGender then
17011 +_DIFF1= 1;
17012 + else
17013 +_DIFF1= 0;
NOTE: %INCLUDE (level 1) ending.
 
NOTE: There were 9686 observations read from the data set BIA.PVA97NK.
NOTE: There were 9686 observations read from the data set EMWS2.IDS2_DATA.
NOTE: View EMWS2.REPL_TRAIN.VIEW used (Total process time):
      real time           0.13 seconds
      cpu time            0.10 seconds
 
NOTE: There were 9686 observations read from the data set EMWS2.STAT_TRAIN.
NOTE: There were 9686 observations read from the data set EMWS2.REPL_TRAIN.
NOTE: The data set WORK._TEMP has 1 observations and 2 variables.
NOTE: DATA statement used (Total process time):
      real time           0.15 seconds
      cpu time            0.12 seconds
 
 
 
NOTE: Appending WORK._TEMP to WORK._TEMPCOUNT.
NOTE: BASE data set does not exist. DATA file is being copied to BASE file.
NOTE: There were 1 observations read from the data set WORK._TEMP.
NOTE: The data set WORK._TEMPCOUNT has 1 observations and 2 variables.
NOTE: PROCEDURE APPEND used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: Deleting WORK._TEMP (memtype=DATA).
NOTE: Fileref _F1 has been deassigned.
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.01 seconds
      cpu time            0.01 seconds
 
 
 
NOTE: There were 1 observations read from the data set WORK._TEMPCOUNT.
NOTE: The data set EMWS2.REPL_COUNT has 1 observations and 2 variables.
NOTE: PROCEDURE TRANSPOSE used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: There were 1 observations read from the data set EMWS2.REPL_COUNT.
NOTE: The data set EMWS2.REPL_COUNT has 1 observations and 2 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.03 seconds
      cpu time            0.00 seconds
 
 
 
WARNING: Multiple lengths were specified for the BY variable Name by input data sets. This might cause unexpected results.
NOTE: There were 1 observations read from the data set WORK.NEWVARINFO.
NOTE: There were 1 observations read from the data set EMWS2.REPL_COUNT.
NOTE: The data set EMWS2.REPL_COUNT has 1 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.04 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: MODIFY was successful for EMWS2.REPL_COUNT.DATA.
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.04 seconds
      cpu time            0.03 seconds
 
 
NOTE: There were 1 observations read from the data set EMWS2.REPL_COUNT.
NOTE: The PROCEDURE PRINT printed page 2.
NOTE: PROCEDURE PRINT used (Total process time):
      real time           0.01 seconds
      cpu time            0.00 seconds
 
 
NOTE: Deleting WORK._TEMPCOUNT (memtype=DATA).
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
 
NOTE: The data set WORK.EM_USER_REPORT has 132 observations and 4 variables.
NOTE: DATA statement used (Total process time):
      real time           0.03 seconds
      cpu time            0.03 seconds
 
 
 
NOTE: Deleting WORK.NEWVARINFO (memtype=DATA).
17014  *------------------------------------------------------------*;
17015  * End REPORT: Repl;
17016  *------------------------------------------------------------*;
17017
17018  /* Reset EM Options */
17019  options formchar="|----|+|---+=|-/\<>*";
17020  options nocenter ls=256 ps=10000;
17021  goptions reset=all device=GIF NODISPLAY;
 
NOTE: PROCEDURE DATASETS used (Total process time):
      real time           0.04 seconds
      cpu time            0.00 seconds
 
 
17022  proc sort data=WORK.EM_USER_REPORT;
17023  by ID VIEW;
17024  run;
 
NOTE: There were 132 observations read from the data set WORK.EM_USER_REPORT.
NOTE: The data set WORK.EM_USER_REPORT has 132 observations and 4 variables.
NOTE: PROCEDURE SORT used (Total process time):
      real time           0.00 seconds
      cpu time            0.00 seconds
 
 
